<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>eBPF Talk: tailcall on x86ã€æ±‡ç¼–æ…å…¥ã€‘ã€è¯‘ã€‘ - LeonHwang&#39;s Blogs</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author"
  content="" /><meta name="description" content="æœ¬æ–‡ç¿»è¯‘è‡ª Assembly within! BPF tail calls on x86 and ARMï¼Œç¿»è¯‘äº†å…¶ä¸­ tailcall ä¸ x86 éƒ¨åˆ†ï¼Œç•¥è¿‡ arm éƒ¨åˆ†ã€‚ eBPF Talk: tailcall ä¸ bpf2bpfã€è¯‘ã€‘ ä»¥ä¸‹ä¸ºè¯‘æ–‡ã€‚ æœ€åˆæˆ‘ä»¬å­¦ä¹ ç¼–ç¨‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å­¦" /><meta name="keywords"
  content="Go, eBPF, eBPF Talk, skbtracer, go-nfnetlink, iptables, iptables-nfqueue" />






<meta name="generator" content="Hugo 0.125.0-DEV with theme even" />


<link rel="canonical" href="https://blog.leonhw.com/post/ebpf-talk-33-tailcall-on-x86/" />
<link rel="apple-touch-icon" sizes="180x180" href="/%20apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/%20favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/%20favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.e319aa82b43bd5b3901ce5d09fd243a802bbfb6a468c088e063c7136d36ae4a7.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="eBPF Talk: tailcall on x86ã€æ±‡ç¼–æ…å…¥ã€‘ã€è¯‘ã€‘" />
<meta property="og:description" content="æœ¬æ–‡ç¿»è¯‘è‡ª Assembly within! BPF tail calls on x86 and ARMï¼Œç¿»è¯‘äº†å…¶ä¸­ tailcall ä¸ x86 éƒ¨åˆ†ï¼Œç•¥è¿‡ arm éƒ¨åˆ†ã€‚ eBPF Talk: tailcall ä¸ bpf2bpfã€è¯‘ã€‘ ä»¥ä¸‹ä¸ºè¯‘æ–‡ã€‚ æœ€åˆæˆ‘ä»¬å­¦ä¹ ç¼–ç¨‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å­¦" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.leonhw.com/post/ebpf-talk-33-tailcall-on-x86/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-05-23T21:48:41+08:00" />
<meta property="article:modified_time" content="2023-05-23T21:48:41+08:00" />

  <meta itemprop="name" content="eBPF Talk: tailcall on x86ã€æ±‡ç¼–æ…å…¥ã€‘ã€è¯‘ã€‘">
  <meta itemprop="description" content="æœ¬æ–‡ç¿»è¯‘è‡ª Assembly within! BPF tail calls on x86 and ARMï¼Œç¿»è¯‘äº†å…¶ä¸­ tailcall ä¸ x86 éƒ¨åˆ†ï¼Œç•¥è¿‡ arm éƒ¨åˆ†ã€‚ eBPF Talk: tailcall ä¸ bpf2bpfã€è¯‘ã€‘ ä»¥ä¸‹ä¸ºè¯‘æ–‡ã€‚ æœ€åˆæˆ‘ä»¬å­¦ä¹ ç¼–ç¨‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å­¦">
  <meta itemprop="datePublished" content="2023-05-23T21:48:41+08:00">
  <meta itemprop="dateModified" content="2023-05-23T21:48:41+08:00">
  <meta itemprop="wordCount" content="5190">
  <meta itemprop="keywords" content="EBPF,Tailcall,Bpf2bpf,X86"><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="eBPF Talk: tailcall on x86ã€æ±‡ç¼–æ…å…¥ã€‘ã€è¯‘ã€‘"/>
<meta name="twitter:description" content="æœ¬æ–‡ç¿»è¯‘è‡ª Assembly within! BPF tail calls on x86 and ARMï¼Œç¿»è¯‘äº†å…¶ä¸­ tailcall ä¸ x86 éƒ¨åˆ†ï¼Œç•¥è¿‡ arm éƒ¨åˆ†ã€‚ eBPF Talk: tailcall ä¸ bpf2bpfã€è¯‘ã€‘ ä»¥ä¸‹ä¸ºè¯‘æ–‡ã€‚ æœ€åˆæˆ‘ä»¬å­¦ä¹ ç¼–ç¨‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å­¦"/>


<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->


<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1873931068599582"
  crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-X2X9EP3K14"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'G-X2X9EP3K14');

  gtag('set', 'linker', {
    'domains': ['asphaltt.github.io', 'le0nhwan9.github.io'],
    'decorate_forms': true
  });
</script>
</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Leon Hwang&#39;s Blogs</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Leon Hwang&#39;s Blogs</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
  
  <header class="post-header">
    <h1 class="post-title">eBPF Talk: tailcall on x86ã€æ±‡ç¼–æ…å…¥ã€‘ã€è¯‘ã€‘</h1>

    <div class="post-meta">
      <span class="post-time"> 2023-05-23 </span>
      <div class="post-category">
        <a href="/%20categories/ebpf/"> eBPF </a>
        <a href="/%20categories/ebpf-talk/"> eBPF Talk </a>
        </div>
      <span class="more-meta"> çº¦ 5190 å­— </span>
      <span class="more-meta"> é¢„è®¡é˜…è¯» 11 åˆ†é’Ÿ </span>
      <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg" /></span> æ¬¡é˜…è¯» </span>
    </div>
  </header>

  <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">æ–‡ç« ç›®å½•</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#call-æŒ‡ä»¤å“ªé‡Œå»äº†"><code>call</code> æŒ‡ä»¤å“ªé‡Œå»äº†ï¼Ÿ</a></li>
        <li><a href="#bpf-tailcall">BPF <code>tailcall</code></a></li>
        <li><a href="#å°¾è°ƒç”¨æ˜¯å°¾è°ƒç”¨æ˜¯å°¾è°ƒç”¨">å°¾è°ƒç”¨æ˜¯å°¾è°ƒç”¨æ˜¯å°¾è°ƒç”¨</a></li>
        <li><a href="#x86-64-ä¸Šçš„-tailcall">x86-64 ä¸Šçš„ <code>tailcall</code></a></li>
        <li><a href="#æ··åˆä½¿ç”¨-bpf2bpf-å’Œ-tailcall">æ··åˆä½¿ç”¨ <code>bpf2bpf</code> å’Œ <code>tailcall</code></a></li>
        <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
  <div class="post-content">
    <p>æœ¬æ–‡ç¿»è¯‘è‡ª <a href="https://blog.cloudflare.com/assembly-within-bpf-tail-calls-on-x86-and-arm/">Assembly within! BPF tail calls on x86 and ARM</a>ï¼Œç¿»è¯‘äº†å…¶ä¸­ <code>tailcall</code> ä¸ x86 éƒ¨åˆ†ï¼Œç•¥è¿‡ arm éƒ¨åˆ†ã€‚</p>
<ul>
<li><a href="/post/ebpf-talk-32-tailcall-and-bpf2bpf/">eBPF Talk: tailcall ä¸ bpf2bpfã€è¯‘ã€‘</a></li>
</ul>
<p>ä»¥ä¸‹ä¸ºè¯‘æ–‡ã€‚</p>
<hr>
<p>æœ€åˆæˆ‘ä»¬å­¦ä¹ ç¼–ç¨‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å­¦ä¹ äº† <a href="https://ocw.mit.edu/courses/6-00sc-introduction-to-computer-science-and-programming-spring-2011/resources/lecture-6-recursion/">é€’å½’</a>ã€‚è¾ƒäºå…¶å®ƒä¸œè¥¿ï¼Œå¦‚å¸¦æœ‰é‡å¤ä»£ç çš„é¡ºåºç»“æ„ï¼Œé€’å½’éå¸¸ä¾¿äºè®¡ç®—ã€‚ä¾‹å¦‚è‘—åçš„ <a href="https://en.wikipedia.org/wiki/Fibonacci_number">Fibonacci æ•°</a> - <em>Fn = Fn-1 + Fn-2</em>ã€‚</p>
<p><img src="/eBPF_Talk_33_tailcall_on_x86_1.png" alt=""></p>
<p>åæ¥ï¼Œéšç€æ·±å…¥å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œæˆ‘ä»¬å­¦åˆ°äº†ä¸€ä¸ªäº‹å®ï¼šè°ƒç”¨å¸§çš„ <a href="https://textbook.cs161.org/memory-safety/x86.html#26-stack-pushing-and-popping">æ ˆç©ºé—´</a> æ˜¯æœ‰é™çš„ã€‚å› è€Œæœ‰ä¸¤ç§ä½¿ç”¨é€’å½’è®¡ç®— Fibonacci æ•°çš„åŠæ³•ï¼š</p>
<p>1ï¼Œokay çš„åŠæ³•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="c1">// fib_okay.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="nf">fib</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>2ï¼Œcool çš„åŠæ³•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="c1">// fib_cool.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">uint64_t</span> <span class="nf">fib_tail</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">n</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">a</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">a</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">fib_tail</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="nf">fib</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">fib_tail</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœæˆ‘ä»¬èƒ½çœ‹ä¸‹ç¼–è¯‘å™¨ç”Ÿæˆçš„æœºå™¨ç ï¼Œcool çš„åŠæ³•ä¸‹ç¿»è¯‘å‡ºä¸€æ®µæ¼‚äº®ä¸”ç´§å‡‘çš„æŒ‡ä»¤åºåˆ—ï¼š</p>
<blockquote>
<p>å£°æ˜ï¼šæœ¬æ–‡æœ‰è¾ƒå¤šçš„æ±‡ç¼–ã€‚æˆ‘ä»¬å°†çœ‹åˆ° x86-64ã€arm64 å’Œ BPF æ¶æ„çš„æ±‡ç¼–ä»£ç ã€‚å¦‚æœéœ€è¦æŒ‡å¯¼ï¼Œæˆ‘æ¨èå¦‚ä¸‹èµ„æ–™ï¼šx86-64 Igor Zhirkov å†™çš„ <a href="https://github.com/Apress/low-level-programming">Low-Level Programming</a>ï¼Œarm64 Stephen Smith å†™çš„ <a href="https://github.com/Apress/programming-with-64-bit-ARM-assembly-language">Programming with 64-Bit ARM Assembly Language</a>ï¼ŒBPF çš„è¯·çœ‹ <a href="https://docs.kernel.org/bpf/instruction-set.html">Linux kernel document</a>ã€‚</p>
</blockquote>
<p><img src="/eBPF_Talk_33_tailcall_on_x86_2.png" alt=""></p>
<p>è€Œ okay çš„åŠæ³•å°±ä»¤äººå¤±æœ›äº†ï¼Œå®ƒå¯¼è‡´äº† <a href="https://github.com/cloudflare/cloudflare-blog/blob/master/2022-10-bpf-tail-call/fib_okay.x86-64.disasm">æ›´å¤šçš„æŒ‡ä»¤</a>ã€‚å®ƒç®€ç›´æ˜¯ä¸€å›¢ <a href="https://en.wikipedia.org/wiki/Basic_block">basic blocks</a> æ„å¤§åˆ©é¢æ¡ã€‚</p>
<p><img src="/eBPF_Talk_33_tailcall_on_x86_3.png" alt=""></p>
<p>ä½†æ›´é‡è¦çš„æ˜¯ï¼Œå®ƒå¹¶æ²¡æœ‰é¿å…æ‰ <a href="https://textbook.cs161.org/memory-safety/x86.html#29-x86-function-call-in-assembly">x86 call æŒ‡ä»¤</a>ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">$ objdump -d fib_okay.o <span class="p">|</span> grep call
</span></span><span class="line"><span class="cl"> 10c:   e8 <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>          call   <span class="m">111</span> &lt;fib+0x111&gt;
</span></span><span class="line"><span class="cl">$ objdump -d fib_cool.o <span class="p">|</span> grep call
</span></span><span class="line"><span class="cl">$
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™å°±å¯¼è‡´ä¸€ä¸ªé‡è¦ç»“æœï¼šéšç€ <code>fib</code> é€’å½’åœ°è°ƒç”¨è‡ªå·±ï¼Œæ ˆå°±ä¸€ç›´å¢é•¿ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ <a href="https://github.com/cloudflare/cloudflare-blog/blob/master/2022-10-bpf-tail-call/trace_rsp.gdb">è°ƒè¯•å™¨</a> è§‚æµ‹åˆ°å®ƒã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">$ gdb --quiet --batch --command<span class="o">=</span>trace_rsp.gdb --args ./fib_okay <span class="m">6</span>
</span></span><span class="line"><span class="cl">Breakpoint <span class="m">1</span> at 0x401188: file fib_okay.c, line 3.
</span></span><span class="line"><span class="cl"><span class="o">[</span>Thread debugging using libthread_db enabled<span class="o">]</span>
</span></span><span class="line"><span class="cl">Using host libthread_db library <span class="s2">&#34;/lib64/libthread_db.so.1&#34;</span>.
</span></span><span class="line"><span class="cl"><span class="nv">n</span> <span class="o">=</span> 6, %rsp <span class="o">=</span> 0xffffd920
</span></span><span class="line"><span class="cl"><span class="nv">n</span> <span class="o">=</span> 5, %rsp <span class="o">=</span> 0xffffd900
</span></span><span class="line"><span class="cl"><span class="nv">n</span> <span class="o">=</span> 4, %rsp <span class="o">=</span> 0xffffd8e0
</span></span><span class="line"><span class="cl"><span class="nv">n</span> <span class="o">=</span> 3, %rsp <span class="o">=</span> 0xffffd8c0
</span></span><span class="line"><span class="cl"><span class="nv">n</span> <span class="o">=</span> 2, %rsp <span class="o">=</span> 0xffffd8a0
</span></span><span class="line"><span class="cl"><span class="nv">n</span> <span class="o">=</span> 1, %rsp <span class="o">=</span> 0xffffd880
</span></span><span class="line"><span class="cl"><span class="nv">n</span> <span class="o">=</span> 1, %rsp <span class="o">=</span> 0xffffd8c0
</span></span><span class="line"><span class="cl"><span class="nv">n</span> <span class="o">=</span> 2, %rsp <span class="o">=</span> 0xffffd8e0
</span></span><span class="line"><span class="cl"><span class="nv">n</span> <span class="o">=</span> 1, %rsp <span class="o">=</span> 0xffffd8c0
</span></span><span class="line"><span class="cl"><span class="nv">n</span> <span class="o">=</span> 3, %rsp <span class="o">=</span> 0xffffd900
</span></span><span class="line"><span class="cl"><span class="nv">n</span> <span class="o">=</span> 2, %rsp <span class="o">=</span> 0xffffd8e0
</span></span><span class="line"><span class="cl"><span class="nv">n</span> <span class="o">=</span> 1, %rsp <span class="o">=</span> 0xffffd8c0
</span></span><span class="line"><span class="cl"><span class="nv">n</span> <span class="o">=</span> 1, %rsp <span class="o">=</span> 0xffffd900
</span></span><span class="line"><span class="cl"><span class="m">13</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>Inferior <span class="m">1</span> <span class="o">(</span>process 50904<span class="o">)</span> exited normally<span class="o">]</span>
</span></span><span class="line"><span class="cl">$
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶è€Œ cool çš„åŠæ³•ä¸‹åˆ™æ²¡æœ‰ä½¿ç”¨æ ˆã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">$ gdb --quiet --batch --command<span class="o">=</span>trace_rsp.gdb --args ./fib_cool <span class="m">6</span>
</span></span><span class="line"><span class="cl">Breakpoint <span class="m">1</span> at 0x40118a: file fib_cool.c, line 13.
</span></span><span class="line"><span class="cl"><span class="o">[</span>Thread debugging using libthread_db enabled<span class="o">]</span>
</span></span><span class="line"><span class="cl">Using host libthread_db library <span class="s2">&#34;/lib64/libthread_db.so.1&#34;</span>.
</span></span><span class="line"><span class="cl"><span class="nv">n</span> <span class="o">=</span> 6, %rsp <span class="o">=</span> 0xffffd938
</span></span><span class="line"><span class="cl"><span class="m">13</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>Inferior <span class="m">1</span> <span class="o">(</span>process 50949<span class="o">)</span> exited normally<span class="o">]</span>
</span></span><span class="line"><span class="cl">$
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="call-æŒ‡ä»¤å“ªé‡Œå»äº†"><code>call</code> æŒ‡ä»¤å“ªé‡Œå»äº†ï¼Ÿ</h2>
<p>èªæ˜çš„ç¼–è¯‘å™¨å°†å‡½æ•°ä½“é‡Œæœ€åçš„å‡½æ•°è°ƒç”¨è½¬æ¢æˆäº†ä¸€ä¸ªå¸¸è§„è·³è½¬ï¼ˆ<code>regular jump</code>ï¼‰ã€‚ä¸ºä»€ä¹ˆå…è®¸è¿™ä¹ˆåšå‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬è°ˆè®ºçš„æ˜¯å‡½æ•°ä½“é‡Œæœ€åä¸€æ¡æŒ‡ä»¤ã€‚åªè¦è¿”å›ï¼ˆ<code>return</code>ï¼‰äº†ï¼Œè°ƒç”¨è€…æ ˆå¸§å°±ä¼šè¢«é”€æ¯ã€‚æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬å¤ç”¨å®ƒå½“ä½œè¢«è°ƒç”¨è€…çš„ <a href="https://eli.thegreenplace.net/2011/02/04/where-the-top-of-the-stack-is-on-x86/">æ ˆå¸§</a> æ—¶ï¼Œä¸ºä»€ä¹ˆè¿˜è¦ä¿ç•™å®ƒå‘¢ï¼Ÿ</p>
<p>è¿™ä¸ªä¼˜åŒ–ï¼Œå³ <a href="https://en.wikipedia.org/wiki/Tail_call#In_assembly">å°¾è°ƒç”¨æ¶ˆé™¤</a>ï¼Œä»¤æˆ‘ä»¬åœ¨ Fibonacci cool åŠæ³•å®ç°ä¸­ä¸éœ€è¦ç”¨åˆ°å‡½æ•°è°ƒç”¨ã€‚æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªè°ƒç”¨å»æ¶ˆé™¤ - å°±æ˜¯æœ€åé‚£ä¸ªã€‚</p>
<p>ä¸€æ—¦åº”ç”¨ï¼Œè°ƒç”¨å˜è·³è½¬ï¼ˆå¾ªç¯ï¼‰ã€‚å¦‚æœæ±‡ç¼–ä¸æ˜¯ä½ çš„ç¬¬äºŒè¯­è¨€ï¼Œä½¿ç”¨ <a href="https://ghidra-sre.org/">Ghidra</a> åç¼–è¯‘æŸ¥çœ‹ fib_cool.o å¯¹è±¡æ–‡ä»¶å»æŸ¥çœ‹è¿™ç§è½¬å˜ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">fib</span><span class="p">(</span><span class="n">ulong</span> <span class="n">param_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">lVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">lVar2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">lVar3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">param_1</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">lVar3</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">lVar3</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">lVar2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">lVar1</span> <span class="o">=</span> <span class="n">lVar3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">param_1</span> <span class="o">=</span> <span class="n">param_1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">lVar3</span> <span class="o">=</span> <span class="n">lVar2</span> <span class="o">+</span> <span class="n">lVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">lVar2</span> <span class="o">=</span> <span class="n">lVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">param_1</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">lVar3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚ä¸ä»…ç”Ÿæˆçš„æœºå™¨ç æ›´çŸ­ï¼Œä¹Ÿå› ä¸ç”¨è°ƒç”¨è€Œå˜å¾—æ›´å¿«ï¼ˆå¯¹æ¯” okay åŠæ³•ä¸‹çš„ <a href="https://github.com/cloudflare/cloudflare-blog/blob/master/2022-10-bpf-tail-call/fib_okay_50.perf.txt#L85">profile</a>ï¼‰ã€‚</p>
<p>ä¸è¿‡æˆ‘ä¸æ˜¯ <a href="https://github.com/dendibakh/perf-ninja">æ€§èƒ½éšè€…</a>ï¼Œä¸”æœ¬æ–‡ä¸æ˜¯å…³äºç¼–è¯‘å™¨ä¼˜åŒ–çš„ã€‚æ‰€ä»¥ä¸ºä»€ä¹ˆæˆ‘è¦å‘Šè¯‰ä½ è¿™äº›å‘¢ï¼Ÿ</p>
<p><img src="/eBPF_Talk_33_tailcall_on_x86_4.jpeg" alt="Alex Dunkel (Maky), CC BY-SA 3.0, via Wikimedia Commons"></p>
<h2 id="bpf-tailcall">BPF <code>tailcall</code></h2>
<p>å°¾è°ƒç”¨æ¶ˆé™¤çš„æ¦‚å¿µä»¥å®ƒè‡ªå·±çš„æ–¹å¼è¿›å…¥åˆ° BPF ä¸–ç•Œï¼Œå°½ç®¡ä¸æ˜¯ä½ å¯èƒ½é¢„æœŸçš„æ–¹å¼ã€‚å¯¹ï¼Œå½“ä½¿ç”¨ <code>-target bpf</code> æ—¶ï¼ŒLLVM ç¼–è¯‘å™¨åœ¨æ„å»ºæ—¶æ¶ˆé™¤äº†æœ«å°¾çš„å‡½æ•°è°ƒç”¨ã€‚è¿™ä¸ªè½¬æ¢å‘ç”Ÿåœ¨ <a href="https://en.wikipedia.org/wiki/Intermediate_representation">IR</a> å±‚é¢ï¼Œæ‰€ä»¥å®ƒä¸æ¶‰åŠç¼–è¯‘å™¨åç«¯ã€‚è¿™èƒ½å¤ŸèŠ‚çœä½ å‡ ä¸ª <a href="https://docs.cilium.io/en/stable/bpf/#bpf-to-bpf-calls">bpf2bpf å‡½æ•°è°ƒç”¨</a>ï¼Œä½ å¯ä»¥çœ‹çœ‹ BPF æ±‡ç¼–é‡Œçš„ <code>call -N</code> æŒ‡ä»¤ã€‚</p>
<p>ç„¶è€Œï¼Œå½“æˆ‘ä»¬åœ¨ BPF è¯­å¢ƒé‡Œè®¨è®º <code>tailcall</code> æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šæƒ³åˆ°å…¶å®ƒä¸€äº›ä¸œè¥¿ã€‚ä¸”è¿™æ˜¯ä¸€ä¸ª BPF JIT ç¼–è¯‘å™¨å†…ç½®çš„ä¸“ä¸º <a href="https://docs.cilium.io/en/stable/bpf/#tail-calls">ä¸²è” BPF ç¨‹åº</a> è€Œç”Ÿçš„æœºåˆ¶ã€‚</p>
<p>æˆ‘ä»¬ç¬¬ä¸€æ¬¡æ¥è§¦ <code>tailcall</code> æ˜¯åœ¨æ„å»ºæˆ‘ä»¬çš„ <a href="https://legacy.netdevconf.info/0x13/session.html?talk-XDP-based-DDoS-mitigation">åŸºäº XDP çš„ç½‘ç»œåŒ…å¤„ç†æµæ°´çº¿</a> çš„æ—¶å€™ã€‚å¤šå¾—å®ƒï¼Œæˆ‘ä»¬æ‰èƒ½å¤Ÿå°†å¤„ç†é€»è¾‘æ‹†åˆ†æˆå¤šä¸ª XDP ç¨‹åºï¼›æ¯ä¸ªç¨‹åºåªåšä¸€ä»¶äº‹ã€‚</p>
<p><img src="/eBPF_Talk_33_tailcall_on_x86_5.png" alt="Slide from â€œXDP based DDoS Mitigationâ€ talk by Arthur Fabre"></p>
<blockquote>
<p><a href="https://legacy.netdevconf.info/0x13/session.html?talk-XDP-based-DDoS-mitigation">XDP based DDoS Mitigation</a></p>
</blockquote>
<p>è‡ªé‚£æ—¶èµ·æˆ‘ä»¬å°±ä¸€ç›´ä½¿ç”¨ <code>tailcall</code>ã€‚ä½†å®ƒä»¬æœ‰å®ƒä»¬çš„ç¨æ”¶ã€‚ç›´åˆ°æœ€è¿‘ï¼ŒåŒæ ·çš„ XDP ç¨‹åºï¼Œåœ¨arm64 ä¸Šå°±ä¸èƒ½åŒæ—¶ä½¿ç”¨ <code>tailcall</code> å’Œ <code>bpf2bpf</code> äº†ã€‚</p>
<p>ä¸ºä»€ä¹ˆï¼Ÿåœ¨å¾—åˆ°ç­”æ¡ˆä¹‹å‰ï¼Œè®©æˆ‘ä»¬æ·±æŒ–ä¸€ä¸‹ <code>tailcall</code> å¦‚ä½•è¿è½¬çš„ã€‚</p>
<h2 id="å°¾è°ƒç”¨æ˜¯å°¾è°ƒç”¨æ˜¯å°¾è°ƒç”¨">å°¾è°ƒç”¨æ˜¯å°¾è°ƒç”¨æ˜¯å°¾è°ƒç”¨</h2>
<p>BPF é€šè¿‡ BPF ä»£ç é‡Œè°ƒç”¨çš„ <a href="https://elixir.bootlin.com/linux/v5.15.63/source/include/uapi/linux/bpf.h#L1712">bpf_tail_call()</a> æ­ç¤ºäº† <code>tailcall</code> æœºåˆ¶ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥çŸ¥é“ä¼šè°ƒç”¨å“ªä¸ª BPF ç¨‹åºã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬ä¼ ç»™å®ƒä¸€ä¸ªæŒæœ‰ BPF ç¨‹åºå¼•ç”¨çš„ BPF mapï¼ˆä¸€ä¸ªå®¹å™¨ã€BPF_MAP_TYPE_PROG_ARRAYï¼‰ï¼Œå’Œä¸€ä¸ªç´¢å¼•ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">bpf_tail_call</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bpf_map</span> <span class="o">*</span><span class="n">prog_array_map</span><span class="p">,</span> <span class="n">u32</span> <span class="n">index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       <span class="n">Description</span>
</span></span><span class="line"><span class="cl">              <span class="n">This</span>  <span class="n">special</span>  <span class="n">helper</span> <span class="n">is</span> <span class="n">used</span> <span class="n">to</span> <span class="n">trigger</span> <span class="n">a</span> <span class="s">&#34;tail call&#34;</span><span class="p">,</span> <span class="n">or</span>
</span></span><span class="line"><span class="cl">              <span class="n">in</span> <span class="n">other</span> <span class="n">words</span><span class="p">,</span> <span class="n">to</span> <span class="n">jump</span> <span class="n">into</span>  <span class="n">another</span>  <span class="n">eBPF</span>  <span class="n">program</span><span class="p">.</span>  <span class="n">The</span>
</span></span><span class="line"><span class="cl">              <span class="n">same</span>  <span class="n">stack</span> <span class="n">frame</span> <span class="n">is</span> <span class="nf">used</span> <span class="p">(</span><span class="n">but</span> <span class="n">values</span> <span class="n">on</span> <span class="n">stack</span> <span class="n">and</span> <span class="n">in</span> <span class="n">reg</span><span class="err">â€</span>
</span></span><span class="line"><span class="cl">              <span class="n">isters</span> <span class="k">for</span> <span class="n">the</span> <span class="n">caller</span> <span class="n">are</span> <span class="n">not</span> <span class="n">accessible</span> <span class="n">to</span>  <span class="n">the</span>  <span class="n">callee</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">              <span class="n">This</span>  <span class="n">mechanism</span>  <span class="n">allows</span>  <span class="k">for</span>  <span class="n">program</span> <span class="n">chaining</span><span class="p">,</span> <span class="n">either</span> <span class="k">for</span>
</span></span><span class="line"><span class="cl">              <span class="n">raising</span> <span class="n">the</span> <span class="n">maximum</span> <span class="n">number</span> <span class="n">of</span> <span class="n">available</span> <span class="n">eBPF</span> <span class="n">instructions</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">or</span>  <span class="n">to</span>  <span class="n">execute</span>  <span class="n">given</span> <span class="n">programs</span> <span class="n">in</span> <span class="n">conditional</span> <span class="n">blocks</span><span class="p">.</span> <span class="n">For</span>
</span></span><span class="line"><span class="cl">              <span class="n">security</span> <span class="n">reasons</span><span class="p">,</span> <span class="n">there</span> <span class="n">is</span> <span class="n">an</span> <span class="n">upper</span> <span class="n">limit</span> <span class="n">to</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span>
</span></span><span class="line"><span class="cl">              <span class="n">successive</span> <span class="n">tail</span> <span class="n">calls</span> <span class="n">that</span> <span class="n">can</span> <span class="n">be</span> <span class="n">performed</span><span class="p">.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><a href="https://man7.org/linux/man-pages/man7/bpf-helpers.7.html">bpf-helpers(7) man page</a></p>
<p>ç¬¬ä¸€çœ¼çœ‹å»ï¼Œè¿™çœ‹ç€æœ‰ç‚¹æƒ³ <a href="https://man7.org/linux/man-pages/man2/execve.2.html">execve(2) ç³»ç»Ÿè°ƒç”¨</a>ã€‚å®ƒå¾ˆå®¹æ˜“è¢«è¯¯è§£ä¸ºåœ¨å½“å‰ç¨‹åºä¸Šä¸‹æ–‡é‡Œå»æ‰§è¡Œæ–°ç¨‹åºçš„æ–¹å¼ã€‚Cilium é¡¹ç›®å‡ºå“çš„ <a href="https://docs.cilium.io/en/stable/bpf/#tail-calls">BPF and XDP Reference Guide</a> æ–‡æ¡£é‡ŒæŒ‡å‡ºï¼š</p>
<blockquote>
<p><code>tailcall</code> å¯ä»¥çœ‹ä½œå…è®¸ä¸€ä¸ª BPF ç¨‹åºè°ƒç”¨å¦ä¸€ä¸ªç¨‹åºçš„æœºåˆ¶ï¼Œè€Œä¸”è¯¥è°ƒç”¨æ— éœ€è¿”å›åŸç¨‹åºã€‚è¿™æ ·çš„è°ƒç”¨å¹¶ä¸åƒå¸¸è§„çš„å‡½æ•°è°ƒç”¨ï¼Œå®ƒå®é™…ç”±ä¸€ä¸ªé•¿è·³è½¬ï¼ˆ<code>long jump</code>ï¼‰æ¥å®ç°ï¼Œå¹¶å¤ç”¨åŒä¸€ä¸ªæ ˆå¸§ï¼ˆ<code>stack frame</code>ï¼‰ã€‚</p>
</blockquote>
<p>ä½†æ˜¯ï¼Œä¸€æ—¦å°† <a href="https://docs.cilium.io/en/stable/bpf/#bpf-to-bpf-calls">BPF å‡½æ•°è°ƒç”¨</a> æ··èµ·æ¥ä½¿ç”¨ï¼Œ<code>tailcall</code> æœºåˆ¶å…¶å®å°±æ˜¯å°¾è°ƒç”¨æ¶ˆé™¤çš„ä¸€ç§å®ç°ï¼Œè€Œä¸æ˜¯ç¨‹åºæ›¿æ¢çš„ç¨‹åºï¼š</p>
<blockquote>
<p>åœ¨çœŸæ­£è¿›å…¥ç›®æ ‡ç¨‹åºä¹‹å‰ï¼Œ<code>tailcall</code> ä¼šé‡Šæ”¾å®ƒæ‰€åœ¨çš„æ ˆå¸§ã€‚å¦‚ä¸Šå›¾ï¼Œå¦‚æœåœ¨å­å‡½æ•°å†…è¿›è¡Œ <code>tailcall</code>ï¼Œå½“ <code>func2</code> ç¨‹åºæ‰§è¡Œæ—¶ä¼šä½¿ç”¨å‡½æ•°ï¼ˆ<code>func1</code>ï¼‰æ ˆå¸§ã€‚ä¸€æ—¦æœ€åçš„å‡½æ•°ï¼ˆ<code>func3</code>ï¼‰ç»“æŸï¼Œå‰é¢æ‰€æœ‰çš„æ ˆå¸§éƒ½ä¼šè¢«é‡Šæ”¾æ‰ï¼Œå¹¶å°†æ§åˆ¶æƒç»™å›åˆ° BPF ç¨‹åºè°ƒç”¨è€…çš„è°ƒç”¨è€…ã€‚</p>
</blockquote>
<p>å”‰ï¼Œæ¥ä¸ªè¯­æ³•ä¸Šçš„å°æƒŠå–œã€‚çœ‹ä¸‹ <a href="https://github.com/cloudflare/cloudflare-blog/blob/master/2022-10-bpf-tail-call/tail_call_ex3.bpf.c">ä¸‹é¢ä¸€æ®µä½¿ç”¨ bpf_tail_call() çš„ BPF ä»£ç </a>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">BPF_MAP_TYPE_PROG_ARRAY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__uint</span><span class="p">(</span><span class="n">key_size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__uint</span><span class="p">(</span><span class="n">value_size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">bar</span> <span class="nf">SEC</span><span class="p">(</span><span class="s">&#34;.maps&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">SEC</span><span class="p">(</span><span class="s">&#34;tc&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">serve_drink</span><span class="p">(</span><span class="k">struct</span> <span class="n">__sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="n">__unused</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mh">0xcafe</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">__noinline</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">bring_order</span><span class="p">(</span><span class="k">struct</span> <span class="n">__sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">bpf_tail_call</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mh">0xf00d</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">SEC</span><span class="p">(</span><span class="s">&#34;tc&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">server1</span><span class="p">(</span><span class="k">struct</span> <span class="n">__sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">bring_order</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">SEC</span><span class="p">(</span><span class="s">&#34;tc&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">server2</span><span class="p">(</span><span class="k">struct</span> <span class="n">__sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__attribute__</span><span class="p">((</span><span class="n">musttail</span><span class="p">))</span> <span class="k">return</span> <span class="nf">bring_order</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢æœ‰ä¸¤ä¸ªçœ‹ç€æ²¡ä»€ä¹ˆåŒºåˆ«çš„ BPF ç¨‹åº - <code>server1()</code> å’Œ <code>server2()</code>.å®ƒä»¬éƒ½è°ƒç”¨åŒä¸€ä¸ª BPF å‡½æ•° <code>bring_order()</code>ã€‚è¯¥å‡½æ•°å°¾è°ƒç”¨äº† <code>serve_drink()</code> ç¨‹åºï¼Œå‡è®¾ <code>[bar[0]</code> map æ¡ç›®æŒ‡å‘å®ƒã€‚</p>
<p>å®ƒä»¬çš„è¿”å›å€¼éƒ½ä¸€æ ·å—ï¼Ÿç­”æ¡ˆå¦‚ä¸‹ - ä¸ï¼Œä»–ä»¬æ²¡æœ‰ã€‚<code>server1</code>è¿”å› ğŸ”ï¼Œè€Œ <code>server2</code> å‘æŒ¥ â˜•ã€‚ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ</p>
<p>éœ€è¦æ³¨æ„çš„ç¬¬ä¸€ä¸ªä¸œè¥¿ï¼ˆ<code>first thing</code>ï¼‰æ˜¯ <code>tailcall</code> é‡Šæ”¾ï¼ˆ<code>unwind</code>ï¼‰çš„ä»…æ˜¯å½“å‰å‡½æ•°æ ˆå¸§ã€‚å‡½æ•°é‡Œçš„ <code>bpf_tail_call()</code> ä»£ç ä»æœªæ‰§è¡Œï¼Œå³ä½¿æŒ‡å®šçš„å°¾è°ƒç”¨æˆåŠŸäº†ï¼ˆmap æ¡ç›®å­˜åœ¨ï¼Œä¸”æœªè§¦åŠå°¾è°ƒç”¨é™åˆ¶ï¼‰ã€‚</p>
<p>å½“å°¾è°ƒç”¨ç»“æŸï¼Œæ§åˆ¶æƒå›åˆ°äº†å‘èµ·å°¾è°ƒç”¨çš„è°ƒç”¨è€…å‡½æ•°æ‰‹ä¸Šã€‚åº”ç”¨åˆ°æˆ‘ä»¬çš„ä¾‹å­ä¸Šï¼Œä¸¤ä¸ªç¨‹åºçš„æ§åˆ¶æµéƒ½æ˜¯ <code>serverX() --&gt; bring_order() --&gt; bpf_tail_call() --&gt; serve_drink() -return-&gt; serverX()</code>ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„ç¬¬äºŒä¸ªä¸œè¥¿æ˜¯ï¼Œç¼–è¯‘å™¨å¹¶ä¸çŸ¥é“ <code>bpf_tail_call()</code> ä¼šæ”¹å˜æ§åˆ¶æµã€‚å› æ­¤ï¼Œæ— çŸ¥çš„ç¼–è¯‘å™¨ä¼˜åŒ–äº†ä»£ç ï¼š<code>tailcall</code> ä¹‹åä¼šç»§ç»­æ‰§è¡Œã€‚</p>
<p><img src="/eBPF_Talk_33_tailcall_on_x86_6.png" alt=""></p>
<blockquote>
<p><code>server1()</code> å’Œ <code>server2()</code> çš„è°ƒç”¨å›¾ï¼ˆ<code>call graph</code>ï¼‰éƒ½ä¸€æ ·ï¼Œä½†å› æ„å»ºæ—¶ï¼ˆ<code>build time</code>ï¼‰ä¼˜åŒ–è€Œè¿”å›å€¼ä¸ä¸€æ ·ã€‚</p>
</blockquote>
<p>åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œç¼–è¯‘å™¨è®¤ä¸ºé‡‡ç”¨ä» <code>bring_order()</code> è¿”å›ç»™ <code>server1()</code> çš„å¸¸é‡æ˜¯æ²¡é—®é¢˜çš„ã€‚å¦‚æœæ²¡æœ‰æ£€æŸ¥ <a href="https://github.com/cloudflare/cloudflare-blog/blob/master/2022-10-bpf-tail-call/tail_call_ex3.bpf.disasm">ç”Ÿæˆçš„ BPF æ±‡ç¼–</a>ï¼Œå¯èƒ½ä¼šå¸¦ç»™æˆ‘ä»¬æƒŠå–œã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ <a href="https://clang.llvm.org/docs/AttributeReference.html#musttail">å¼ºè¡Œä»¤ç¼–è¯‘å™¨ musttail</a> å»å°¾è°ƒç”¨ <code>bring_order()</code>ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥ä¿è¯æ— è®º <code>bring_order()</code> è¿”å›ä»€ä¹ˆéƒ½è¢«å½“ä½œ <code>server2()</code> ç¨‹åºç»“æœã€‚</p>
<p>ğŸ›ˆ ä¸€èˆ¬è§„åˆ™ï¼šä¸ºäº†æœ€å°æƒŠå–œç»“æœï¼Œå½“è°ƒç”¨ä¸€ä¸ªåŒ…å« <code>tailcall</code> çš„å‡½æ•°æ—¶ï¼Œä½¿ç”¨ <a href="https://clang.llvm.org/docs/AttributeReference.html#musttail">musttail å±æ€§</a>ã€‚</p>
<p><code>bpf_tail_call()</code> åº•å±‚æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿæ˜¯æ—¶å€™æ·±æŒ–äº†ã€‚</p>
<p><img src="/eBPF_Talk_33_tailcall_on_x86_7.jpeg" alt="Public Domain image"></p>
<h2 id="x86-64-ä¸Šçš„-tailcall">x86-64 ä¸Šçš„ <code>tailcall</code></h2>
<p>åœ¨ x86-64 BPF JIT ç¼–è¯‘ä¹‹åï¼Œ<code>bpf_tail_call()</code> ä¼šè¢«ç¿»è¯‘æˆä»€ä¹ˆå‘¢ï¼Ÿx86-64 ä¸Šçš„å®ç°æ˜¯å¦‚ä½•ç¡®ä¿ä¸ä¼šæ°¸è¿œåœ°å å…¥ <code>tailcall</code> å¾ªç¯çš„ï¼Ÿ</p>
<p>ä¸ºäº†è§£å¯†ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæ‹¼å‡‘å‡ ä¸ªä¸œè¥¿ã€‚</p>
<p>ç¬¬ä¸€ä¸ªæ˜¯ BPF JIT ç¼–è¯‘å™¨æºä»£ç ï¼Œ<a href="https://elixir.bootlin.com/linux/v5.19.12/source/arch/x86/net/bpf_jit_comp.c">arch/x86/net/bpf_jit_comp.c</a>ã€‚æºä»£ç é‡Œæœ‰ä¸å°‘æœ‰ç”¨çš„æ³¨é‡Šã€‚æˆ‘ä»¬åªéœ€å…³å¿ƒ JIT é‡Œçš„ä»¥ä¸‹è°ƒç”¨é“¾ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="c1">// ${KERNEL}/arch/x86/net/bpf_jit_comp.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nf">do_jit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">|--&gt;</span><span class="nf">emit_prologue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">|--&gt;</span><span class="nf">push_callee_regs</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">insn_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">insn</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">switch</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">BPF_JMP</span> <span class="o">|</span> <span class="nl">BPF_CALL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* emit function call */</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">BPF_JMP</span> <span class="o">|</span> <span class="nl">BPF_TAIL_CALL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nf">emit_bpf_tail_call_direct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">BPF_JMP</span> <span class="o">|</span> <span class="nl">BPF_EXIT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* emit epilogue */</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æœ‰æ—¶æ˜¯å¾ˆéš¾ä»ç¼–è¯‘å™¨æºä»£ç ä¸­æ„æƒ³ç”Ÿæˆçš„æŒ‡ä»¤æµã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦è§‚å¯Ÿ JIT ç¼–è¯‘å™¨çš„è¾“å…¥ï¼ˆBPF æŒ‡ä»¤ï¼‰å’Œè¾“å‡ºï¼ˆx86-64 æŒ‡ä»¤ï¼‰ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>bpftool prog dump</code> æ¥è§‚å¯Ÿå·²åŠ è½½ï¼ˆ<code>loaded</code>ï¼‰ BPF ç¨‹åºçš„ BPF æŒ‡ä»¤å’Œ x86-64 æŒ‡ä»¤ã€‚ç„¶è€Œï¼Œé¦–å…ˆæˆ‘ä»¬å¿…é¡»å¡«å……ç”¨äºå°¾è°ƒç”¨è·³è¡¨ï¼ˆ<code>jump table</code>ï¼‰çš„ BPF mapã€‚å¦åˆ™ï¼Œæˆ‘ä»¬å¯èƒ½çœ‹ä¸åˆ°å°¾è°ƒç”¨è·³è½¬ã€‚</p>
<p>è¿™æ˜¯å› ä¸º <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=428d5df1fa4f28daf622c48dd19da35585c9053c">æŸæ¬¡ä¼˜åŒ–</a>ï¼šå½“åŠ è½½æ—¶å·²çŸ¥ç¨‹åºæ•°ç»„ç´¢å¼•æ—¶ï¼Œå°±ä½¿ç”¨æŒ‡ä»¤è¡¥ä¸ï¼ˆ<code>instruction patching</code>ï¼‰ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl"><span class="c1"># bpftool prog loadall ./tail_call_ex1.o /sys/fs/bpf pinmaps /sys/fs/bpf</span>
</span></span><span class="line"><span class="cl"><span class="c1"># bpftool map update pinned /sys/fs/bpf/jmp_table key 0 0 0 0 value pinned /sys/fs/bpf/target_prog</span>
</span></span><span class="line"><span class="cl"><span class="c1"># bpftool prog dump xlated pinned /sys/fs/bpf/entry_prog</span>
</span></span><span class="line"><span class="cl">int entry_prog<span class="o">(</span>struct __sk_buff * skb<span class="o">)</span>:
</span></span><span class="line"><span class="cl"><span class="p">;</span> bpf_tail_call<span class="o">(</span>skb, <span class="p">&amp;</span>jmp_table, 0<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   0: <span class="o">(</span>18<span class="o">)</span> <span class="nv">r2</span> <span class="o">=</span> map<span class="o">[</span>id:24<span class="o">]</span>
</span></span><span class="line"><span class="cl">   2: <span class="o">(</span>b7<span class="o">)</span> <span class="nv">r3</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">   3: <span class="o">(</span>85<span class="o">)</span> call bpf_tail_call#12
</span></span><span class="line"><span class="cl"><span class="p">;</span> <span class="k">return</span> 0xf00d<span class="p">;</span>
</span></span><span class="line"><span class="cl">   4: <span class="o">(</span>b7<span class="o">)</span> <span class="nv">r0</span> <span class="o">=</span> <span class="m">61453</span>
</span></span><span class="line"><span class="cl">   5: <span class="o">(</span>95<span class="o">)</span> <span class="nb">exit</span>
</span></span><span class="line"><span class="cl"><span class="c1"># bpftool prog dump jited pinned /sys/fs/bpf/entry_prog</span>
</span></span><span class="line"><span class="cl">int entry_prog<span class="o">(</span>struct __sk_buff * skb<span class="o">)</span>:
</span></span><span class="line"><span class="cl">bpf_prog_4f697d723aa87765_entry_prog:
</span></span><span class="line"><span class="cl"><span class="p">;</span> bpf_tail_call<span class="o">(</span>skb, <span class="p">&amp;</span>jmp_table, 0<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   0:   nopl   0x0<span class="o">(</span>%rax,%rax,1<span class="o">)</span>
</span></span><span class="line"><span class="cl">   5:   xor    %eax,%eax
</span></span><span class="line"><span class="cl">   7:   push   %rbp
</span></span><span class="line"><span class="cl">   8:   mov    %rsp,%rbp
</span></span><span class="line"><span class="cl">   b:   push   %rax
</span></span><span class="line"><span class="cl">   c:   movabs <span class="nv">$0</span>xffff888102764800,%rsi
</span></span><span class="line"><span class="cl">  16:   xor    %edx,%edx
</span></span><span class="line"><span class="cl">  18:   mov    -0x4<span class="o">(</span>%rbp<span class="o">)</span>,%eax
</span></span><span class="line"><span class="cl">  1e:   cmp    <span class="nv">$0</span>x21,%eax
</span></span><span class="line"><span class="cl">  21:   jae    0x0000000000000037
</span></span><span class="line"><span class="cl">  23:   add    <span class="nv">$0</span>x1,%eax
</span></span><span class="line"><span class="cl">  26:   mov    %eax,-0x4<span class="o">(</span>%rbp<span class="o">)</span>
</span></span><span class="line"><span class="cl">  2c:   nopl   0x0<span class="o">(</span>%rax,%rax,1<span class="o">)</span>
</span></span><span class="line"><span class="cl">  31:   pop    %rax
</span></span><span class="line"><span class="cl">  32:   jmp    0xffffffffffffffe3   // bug? ğŸ¤”
</span></span><span class="line"><span class="cl"><span class="p">;</span> <span class="k">return</span> 0xf00d<span class="p">;</span>
</span></span><span class="line"><span class="cl">  37:   mov    <span class="nv">$0</span>xf00d,%eax
</span></span><span class="line"><span class="cl">  3c:   leave
</span></span><span class="line"><span class="cl">  3d:   ret
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„äº†ï¼Œ<code>bpftool prog dump jited</code> çœ‹åˆ°çš„å°¾è°ƒç”¨è·³è½¬çš„ç›®æ ‡åœ°å€æ˜¯æ²¡æœ‰ä»»ä½•æ„ä¹‰çš„ã€‚ä¸ºäº†å‘ç°çœŸæ­£çš„è·³è½¬ç›®æ ‡åœ°å€ï¼Œæˆ‘ä»¬å¿…é¡»æ·±å…¥å†…æ ¸å†…å­˜ã€‚åœ¨æˆ‘ä»¬åœ¨ <code>/proc/kallsyms</code> ä¸­æ‰¾åˆ° JIT åçš„ BPF ç¨‹åºåœ°å€åï¼Œ<code>gdb</code> æ´¾ä¸Šç”¨åœºã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl"><span class="c1"># tail -2 /proc/kallsyms</span>
</span></span><span class="line"><span class="cl">ffffffffa0000720 t bpf_prog_f85b2547b00cbbe9_target_prog        <span class="o">[</span>bpf<span class="o">]</span>
</span></span><span class="line"><span class="cl">ffffffffa0000748 t bpf_prog_4f697d723aa87765_entry_prog <span class="o">[</span>bpf<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># gdb -q -c /proc/kcore -ex &#39;x/18i 0xffffffffa0000748&#39; -ex &#39;quit&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>New process 1<span class="o">]</span>
</span></span><span class="line"><span class="cl">Core was generated by <span class="sb">`</span><span class="nv">earlyprintk</span><span class="o">=</span>serial,ttyS0,115200 <span class="nv">console</span><span class="o">=</span>ttyS0 psmouse.proto<span class="o">=</span>exps <span class="s2">&#34;virtme_stty_c&#39;.
</span></span></span><span class="line"><span class="cl"><span class="s2">#0  0x0000000000000000 in ?? ()
</span></span></span><span class="line"><span class="cl"><span class="s2">   0xffffffffa0000748:  nopl   0x0(%rax,%rax,1)
</span></span></span><span class="line"><span class="cl"><span class="s2">   0xffffffffa000074d:  xor    %eax,%eax
</span></span></span><span class="line"><span class="cl"><span class="s2">   0xffffffffa000074f:  push   %rbp
</span></span></span><span class="line"><span class="cl"><span class="s2">   0xffffffffa0000750:  mov    %rsp,%rbp
</span></span></span><span class="line"><span class="cl"><span class="s2">   0xffffffffa0000753:  push   %rax
</span></span></span><span class="line"><span class="cl"><span class="s2">   0xffffffffa0000754:  movabs </span><span class="nv">$0</span><span class="s2">xffff888102764800,%rsi
</span></span></span><span class="line"><span class="cl"><span class="s2">   0xffffffffa000075e:  xor    %edx,%edx
</span></span></span><span class="line"><span class="cl"><span class="s2">   0xffffffffa0000760:  mov    -0x4(%rbp),%eax
</span></span></span><span class="line"><span class="cl"><span class="s2">   0xffffffffa0000766:  cmp    </span><span class="nv">$0</span><span class="s2">x21,%eax
</span></span></span><span class="line"><span class="cl"><span class="s2">   0xffffffffa0000769:  jae    0xffffffffa000077f
</span></span></span><span class="line"><span class="cl"><span class="s2">   0xffffffffa000076b:  add    </span><span class="nv">$0</span><span class="s2">x1,%eax
</span></span></span><span class="line"><span class="cl"><span class="s2">   0xffffffffa000076e:  mov    %eax,-0x4(%rbp)
</span></span></span><span class="line"><span class="cl"><span class="s2">   0xffffffffa0000774:  nopl   0x0(%rax,%rax,1)
</span></span></span><span class="line"><span class="cl"><span class="s2">   0xffffffffa0000779:  pop    %rax
</span></span></span><span class="line"><span class="cl"><span class="s2">   0xffffffffa000077a:  jmp    0xffffffffa000072b
</span></span></span><span class="line"><span class="cl"><span class="s2">   0xffffffffa000077f:  mov    </span><span class="nv">$0</span><span class="s2">xf00d,%eax
</span></span></span><span class="line"><span class="cl"><span class="s2">   0xffffffffa0000784:  leave
</span></span></span><span class="line"><span class="cl"><span class="s2">   0xffffffffa0000785:  ret
</span></span></span><span class="line"><span class="cl"><span class="s2"># gdb -q -c /proc/kcore -ex &#39;x/7i 0xffffffffa0000720&#39; -ex &#39;quit&#39;
</span></span></span><span class="line"><span class="cl"><span class="s2">[New process 1]
</span></span></span><span class="line"><span class="cl"><span class="s2">Core was generated by `earlyprintk=serial,ttyS0,115200 console=ttyS0 psmouse.proto=exps &#34;</span>virtme_stty_c<span class="err">&#39;</span>.
</span></span><span class="line"><span class="cl"><span class="c1">#0  0x0000000000000000 in ?? ()</span>
</span></span><span class="line"><span class="cl">   0xffffffffa0000720:  nopl   0x0<span class="o">(</span>%rax,%rax,1<span class="o">)</span>
</span></span><span class="line"><span class="cl">   0xffffffffa0000725:  xchg   %ax,%ax
</span></span><span class="line"><span class="cl">   0xffffffffa0000727:  push   %rbp
</span></span><span class="line"><span class="cl">   0xffffffffa0000728:  mov    %rsp,%rbp
</span></span><span class="line"><span class="cl">   0xffffffffa000072b:  mov    <span class="nv">$0</span>xcafe,%eax
</span></span><span class="line"><span class="cl">   0xffffffffa0000730:  leave
</span></span><span class="line"><span class="cl">   0xffffffffa0000731:  ret
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æœ€åï¼ŒJIT ç¼–è¯‘å™¨ä½¿ç”¨çš„ BPF å¯„å­˜å™¨å’Œç¡¬ä»¶å¯„å­˜å™¨ä¹‹é—´çš„ <a href="https://elixir.bootlin.com/linux/v5.15.63/source/arch/x86/net/bpf_jit_comp.c#L104">å¯¹ç…§è¡¨</a> æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:center">BPF</th>
<th style="text-align:center">x86-64</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">r0</td>
<td style="text-align:center">rax</td>
</tr>
<tr>
<td style="text-align:center">r1</td>
<td style="text-align:center">rdi</td>
</tr>
<tr>
<td style="text-align:center">r2</td>
<td style="text-align:center">rsi</td>
</tr>
<tr>
<td style="text-align:center">r3</td>
<td style="text-align:center">rdx</td>
</tr>
<tr>
<td style="text-align:center">r4</td>
<td style="text-align:center">rcx</td>
</tr>
<tr>
<td style="text-align:center">r5</td>
<td style="text-align:center">r8</td>
</tr>
<tr>
<td style="text-align:center">r6</td>
<td style="text-align:center">rbx</td>
</tr>
<tr>
<td style="text-align:center">r7</td>
<td style="text-align:center">r13</td>
</tr>
<tr>
<td style="text-align:center">r8</td>
<td style="text-align:center">r14</td>
</tr>
<tr>
<td style="text-align:center">r9</td>
<td style="text-align:center">r15</td>
</tr>
<tr>
<td style="text-align:center">r10</td>
<td style="text-align:center">rbp</td>
</tr>
<tr>
<td style="text-align:center">internal</td>
<td style="text-align:center">r9-r12</td>
</tr>
</tbody>
</table>
<p>å¦‚ä»Šï¼Œæˆ‘ä»¬å‡†å¤‡ææ˜ç™½ä½¿ç”¨ <code>tailcall</code> æ—¶å‘ç”Ÿäº†ä»€ä¹ˆã€‚</p>
<p><img src="/eBPF_Talk_33_tailcall_on_x86_8.png" alt=""></p>
<p>æœ¬è´¨ä¸Šï¼Œ<code>bpf_tail_call()</code> å°±æ˜¯è·³è½¬å¦ä¸€ä¸ªå‡½æ•°ã€å¤ç”¨å½“å‰æ ˆå¸§çš„è·³è½¬ã€‚å®ƒå°±åƒä¸€ä¸ªå¸¸è§„ä¼˜åŒ–çš„å°¾è°ƒç”¨ï¼Œä½†æœ‰ç‚¹ç‚¹ç»•ã€‚</p>
<p>å› ä¸º BPF å®‰å…¨å¿…é¡»ä¿è¯ BPF ç¨‹åºæ‰§è¡Œä¼šç»“æŸã€æ²¡æœ‰æ ˆæº¢å‡ºï¼Œæ‰€ä»¥å°¾è°ƒç”¨æ¬¡æ•°æœ‰é™åˆ¶ï¼ˆ<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ebf7f6f0a6cdcc17a3da52b81e4b3a98c4005028">MAX_TAIL_CALL_CNT = 33</a>ï¼‰ã€‚</p>
<p>åœ¨ BPF ç¨‹åºä¹‹é—´è®¡æ•°å°¾è°ƒç”¨ä¸æ˜¯åŠ è½½æ—¶çš„äº‹æƒ…ã€‚è·³è¡¨ï¼ˆ<code>jump table</code>ï¼‰ï¼ˆBPF ç¨‹åºæ•°ç»„ï¼‰çš„å†…å®¹å¯ä»¥åœ¨ç¨‹åºè¢«æ ¡éªŒåè¢«å˜æ›´ã€‚æˆ‘ä»¬å”¯ä¸€é€‰é¡¹å°±æ˜¯åœ¨è¿è¡Œæ—¶è·Ÿè¸ªå°¾è°ƒç”¨ã€‚è¿™å°±æ˜¯ <code>bpf_tail_call()</code> å¸®åŠ©å‡½æ•° JIT åçš„ä»£ç æ£€æŸ¥å¹¶æ›´æ–° <code>tail_call_cnt</code> è®¡æ•°å™¨çš„åŸå› ã€‚</p>
<p>å¦‚æˆ‘ä»¬æ‰€è§ï¼Œé€šè¿‡ <code>rax</code> å¯„å­˜å™¨ï¼ˆBPF <code>r0</code> å¯„å­˜å™¨ï¼‰ï¼Œæ›´æ–°åçš„è®¡æ•°å™¨ä¼šä»ä¸€ä¸ª BPF ç¨‹åºä¼ åˆ°å¦ä¸€ä¸ªï¼Œä»ä¸€ä¸ª BPF å‡½æ•°ä¼ åˆ°å¦ä¸€ä¸ªã€‚</p>
<p>å¹¸è¿çš„æ˜¯ï¼Œx86-64 è°ƒç”¨è§„çº¦è§„å®š <code>rax</code> å¯„å­˜å™¨ä¸å‚ä¸ä¼ é€’å‡½æ•°å‚æ•°ï¼Œä½†ç›¸ååœ°ä¼šä¿å­˜å‡½æ•°è¿”å›å€¼ã€‚JIT å°±å¯ä»¥ç”¨å®ƒæ¥ä¼ é€’é¢å¤–çš„ã€éšè—çš„å‚æ•°ã€‚</p>
<p>ç„¶åï¼Œå‡½æ•°ä½“å¯ä»¥éšæ„ä½¿ç”¨ <code>r0</code>/<code>rax</code> å¯„å­˜å™¨ã€‚è¿™å°±è§£é‡Šäº†åœ¨è·³è½¬åˆ°å¦ä¸€ä¸ªç¨‹åºåéœ€è¦ç«‹åˆ»å°† <code>rax</code> ä¼ é€’çš„ <code>bpf_tail_cnt</code> ä¿å­˜åˆ°æ ˆä¸Šã€‚ä¹‹å <code>bpf_tail_call()</code> å°±å¯ä»¥ä»æ ˆä¸Šå·²çŸ¥ä½ç½®åŠ è½½å€¼ã€‚</p>
<p>ç»“åˆæ¯ä¸ª <code>bpf_tail_call()</code> è°ƒç”¨ <a href="https://elixir.bootlin.com/linux/v5.15.63/source/arch/x86/net/bpf_jit_comp.c#L1437">ç”Ÿæˆçš„ä»£ç </a>å’Œ <a href="https://elixir.bootlin.com/linux/v5.15.63/source/arch/x86/net/bpf_jit_comp.c#L281">BPF å‡½æ•°åºè¨€</a> ï¼ˆ<code>BPF function prologue</code>ï¼‰ï¼Œå°±å¯ä»¥åœ¨å¤šä¸ª BPF ç¨‹åºä¹‹é—´è·Ÿè¸ªå°¾è°ƒç”¨è®¡æ•°ã€‚</p>
<p>ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬çš„ BPF ç¨‹åºå‰²è£‚æˆå¥½å‡ ä¸ª BPF å‡½æ•°ï¼Œæ¯ä¸ªå‡½æ•°éƒ½æœ‰å…¶æ ˆå¸§å‘¢ï¼Ÿå¦‚æœè¿™äº›å‡½æ•°éƒ½æœ‰ <code>tailcall</code> å‘¢ï¼Ÿæ¥ç€å°¾è°ƒç”¨æŠ€æœ¯è¯¥å¦‚ä½•è·Ÿè¸ªå‘¢ï¼Ÿ</p>
<h2 id="æ··åˆä½¿ç”¨-bpf2bpf-å’Œ-tailcall">æ··åˆä½¿ç”¨ <code>bpf2bpf</code> å’Œ <code>tailcall</code></h2>
<p>å—å†…éƒ¨å®ç°å½±å“ï¼Œå½“è°ˆåŠå‡½æ•°å’Œå‡½æ•°è°ƒç”¨æ—¶ï¼ŒBPF æœ‰å…¶è‡ªå·±çš„æœ¯è¯­ã€‚å‡½æ•°è°ƒç”¨å·²ç§°ä½œ <a href="https://docs.cilium.io/en/stable/bpf/#bpf-to-bpf-calls">BPF åˆ° BPF è°ƒç”¨</a>ã€‚å¯¹åº”çš„ï¼ŒBPF ä»£ç ä¸­çš„ä¸»å‡½æ•°/å…¥å£å‡½æ•°å«ä½œâ€œç¨‹åºâ€ï¼Œè€Œå…¶å®ƒå‡½æ•°å°±æ˜¯â€œå­ç¨‹åºâ€ã€‚</p>
<p>æ¯ä¸ªå­ç¨‹åºéƒ½ä¼šä¸ºæœ¬åœ°çŠ¶æ€åˆ†é…ç›´è‡³å‡½æ•°è¿”å›éƒ½ä¼šç»´æŒçš„æ ˆå¸§ã€‚è‡ªç„¶åœ°ï¼ŒåµŒå¥—çš„ BPF å­ç¨‹åºè°ƒç”¨æ„æˆä¸€ä¸ªè°ƒç”¨é“¾ã€‚å°±åƒç”¨æˆ·æ€çš„åµŒå¥—å‡½æ•°è°ƒç”¨ã€‚</p>
<p>åœ¨ BPF å­ç¨‹åºä¸­ä¹Ÿæ˜¯å¯ä»¥ä½¿ç”¨ <code>tailcall</code> çš„ã€‚éå¸¸æœ‰æˆæ•ˆåœ°ï¼Œè¿™æ˜¯ä¸ªå°†è°ƒç”¨é“¾æ‰©å±•åˆ°å…¶å®ƒ BPF ç¨‹åºåŠå…¶å­ç¨‹åºçš„æœºåˆ¶ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬ä¸èƒ½è·Ÿè¸ªè°ƒç”¨é“¾æœ‰å¤šé•¿ã€æ¯ä¸ªå‡½æ•°ä½¿ç”¨çš„æ ˆç©ºé—´æœ‰å¤šå°‘ï¼Œæˆ‘ä»¬å°±ä¼šé™·å…¥ <a href="https://en.wikipedia.org/wiki/Stack_overflow">æ ˆæº¢å‡º</a> çš„é£é™©ä¸­ã€‚æˆ‘ä»¬ä¸èƒ½è®©å…¶å‘ç”Ÿï¼Œæ‰€ä»¥ BPF <a href="https://elixir.bootlin.com/linux/v5.15.62/source/kernel/bpf/verifier.c#L3600">å¼ºè¡Œé™åˆ¶äº† <code>tailcall</code></a>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">check_max_stack_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">bpf_verifier_env</span> <span class="o">*</span><span class="n">env</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="err">â€¦</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* protect against potential stack overflow that might happen when
</span></span></span><span class="line"><span class="cl"><span class="cm">         * bpf2bpf calls get combined with tailcalls. Limit the caller&#39;s stack
</span></span></span><span class="line"><span class="cl"><span class="cm">         * depth for such case down to 256 so that the worst case scenario
</span></span></span><span class="line"><span class="cl"><span class="cm">         * would result in 8k stack size (32 which is tailcall limit * 256 =
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 8k).
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * To get the idea what might happen, see an example:
</span></span></span><span class="line"><span class="cl"><span class="cm">         * func1 -&gt; sub rsp, 128
</span></span></span><span class="line"><span class="cl"><span class="cm">         *  subfunc1 -&gt; sub rsp, 256
</span></span></span><span class="line"><span class="cl"><span class="cm">         *  tailcall1 -&gt; add rsp, 256
</span></span></span><span class="line"><span class="cl"><span class="cm">         *   func2 -&gt; sub rsp, 192 (total stack size = 128 + 192 = 320)
</span></span></span><span class="line"><span class="cl"><span class="cm">         *   subfunc2 -&gt; sub rsp, 64
</span></span></span><span class="line"><span class="cl"><span class="cm">         *   subfunc22 -&gt; sub rsp, 128
</span></span></span><span class="line"><span class="cl"><span class="cm">         *   tailcall2 -&gt; add rsp, 128
</span></span></span><span class="line"><span class="cl"><span class="cm">         *    func3 -&gt; sub rsp, 32 (total stack size 128 + 192 + 64 + 32 = 416)
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * tailcall will unwind the current stack frame but it will not get rid
</span></span></span><span class="line"><span class="cl"><span class="cm">         * of caller&#39;s stack as shown on the example above.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&amp;&amp;</span> <span class="n">subprog</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">has_tail_call</span> <span class="o">&amp;&amp;</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">verbose</span><span class="p">(</span><span class="n">env</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;tail_calls are not allowed when call stack of previous frames is %d bytes. Too large</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">depth</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="err">â€¦</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ ˆæ·±åº¦ï¼ˆ<code>stack depth</code>ï¼‰åœ¨åŠ è½½æ—¶ç”± BPF æ ¡éªŒå™¨è®¡ç®—å¾—åˆ°ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦åœ¨è¿è¡Œæ—¶ä¿æŒè®¡æ•°å°¾è°ƒç”¨è·³è½¬ï¼›å³ä½¿æ¶‰åŠå­ç¨‹åºã€‚</p>
<p>è¿™æ„å‘³ç€ï¼Œæˆ‘ä»¬å¿…é¡»ä»ä¸€ä¸ª BPF å­ç¨‹åºåˆ°å¦ä¸€ä¸ªå­ç¨‹åºä¹‹é—´ä¼ é€’å°¾è°ƒç”¨è®¡æ•°ï¼Œå°±åƒ <code>tailcall</code> æ—¶çš„åšæ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å†ä¸€æ¬¡é€šè¿‡ <code>rax</code> å¯„å­˜å™¨ä¼ å€¼ã€‚</p>
<p><img src="/eBPF_Talk_33_tailcall_on_x86_9.png" alt="Control flow in a BPF program with a function call followed by a tail call."></p>
<p>ğŸ›ˆ ç®€å•èµ·è§ï¼Œä¾‹å­ä¸­çš„ BPF ä»£ç ä¸åœ¨æ ˆä¸Šåˆ†é…ä»»ä½•ä¸œè¥¿ã€‚æˆ‘å»ºè®®ä½ æ£€æŸ¥ä¸€ä¸‹å½“ä½  <a href="https://elixir.bootlin.com/linux/v5.19.11/source/tools/testing/selftests/bpf/progs/tailcall_bpf2bpf6.c#L37">åŠ ä¸€äº›å±€éƒ¨å˜é‡</a> æ—¶ JIT åçš„æœºå™¨æ±‡ç¼–ä»£ç å˜åŒ–ï¼›åªéœ€ä¿è¯ç¼–è¯‘å™¨ä¸å°†å®ƒä»¬ä¼˜åŒ–æ‰ã€‚</p>
<p>ä¸ºäº†æˆåŠŸï¼Œæˆ‘ä»¬éœ€è¦ï¼š</p>
<p>â‘  åœ¨ <code>call</code> å­ç¨‹åºå‰å°†ä¿å­˜åœ¨æ ˆä¸Šçš„å°¾è°ƒç”¨è®¡æ•°åŠ è½½åˆ° <code>rax</code> å¯„å­˜å™¨ä¸­ï¼Œ</p>
<p>â‘¡ è°ƒæ•´å­ç¨‹åºåºè¨€ï¼ˆ<code>prologue</code>ï¼‰ï¼Œä½¿å…¶ä¸è¦åƒä¸»ç¨‹åºä¸€æ ·é‡ç½® <code>rax</code>ï¼Œ</p>
<p>â‘¢ å°†ä¼ è¿‡æ¥çš„å°¾è°ƒç”¨è®¡æ•°ä¿å­˜åˆ°å­ç¨‹åºçš„æ ˆä¸Šï¼Œä»¥é˜² <code>bpf_tail_call()</code> å¸®åŠ©å‡½æ•°ç”¨åˆ°ã€‚</p>
<p>å­ç¨‹åºä¸­çš„ <code>bpf_tail_call()</code> å°±ä¼šï¼š</p>
<p>â‘£ ä»æ ˆä¸ŠåŠ è½½å°¾è°ƒç”¨è®¡æ•°ï¼Œ</p>
<p>â‘¤ é‡Šæ”¾ï¼ˆ<code>unwind</code>ï¼‰BPF æ ˆï¼Œå½“å®é™…ä¸Šä¼šä¿ç•™å½“å‰å­ç¨‹åºæ ˆå¸§ï¼Œ</p>
<p>â‘¥ è·³è½¬åˆ°ç›®æ ‡ BPF ç¨‹åºã€‚</p>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²çœ‹åˆ°æ‹¼å›¾ç¢ç‰‡æ‹¼å‡‘ä¸€èµ·ä½¿å¾— <code>tailcall</code> åœ¨ x86-64 ä¸Šå®‰å…¨åœ°å·¥ä½œèµ·æ¥ã€‚</p>
<blockquote>
<p>ç•¥è¿‡ <code>tailcall on arm64</code> éƒ¨åˆ†ã€‚</p>
</blockquote>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>ä»é€’å½’åˆ° BPF JITã€‚æˆ‘ä»¬æ˜¯å¦‚ä½•åšåˆ°çš„ï¼Ÿä¸é‡è¦ã€‚é‡è¦çš„æ˜¯è¿™ä¸ªè¿‡ç¨‹ã€‚</p>
<p>åœ¨è¿™è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬æ­ç¤ºäº† <code>tailcall</code> èƒŒåçš„ç§˜å¯†ï¼Œå¹¶å¸Œæœ›èƒ½æŠ‘åˆ¶ä½ä½ çš„å­¦ä¹ åº•å±‚ç¼–ç¨‹ï¼ˆ<code>low-level programming</code>ï¼‰çš„æ¸´æœ›ï¼›è‡³å°‘æ˜¯ä»Šå¤©ã€‚</p>
<p>å‰©ä¸‹çš„å°±æ˜¯åšä¸‹æ¥ç­‰å¾…æˆ‘ä»¬çš„å·¥ä½œæˆæœã€‚é€šè¿‡ GDB åœ¨ VM ä¸ŠæŒ‚é’©å­ï¼Œæˆ‘ä»¬èƒ½å¤Ÿè§‚æµ‹åˆ° BPF ç¨‹åºæ˜¯å¦‚ä½•è°ƒç”¨ BPF å‡½æ•°çš„ã€æ˜¯å¦‚ä½•ä»é‚£å°¾è°ƒç”¨å¦ä¸€ä¸ª BPF ç¨‹åºçš„ï¼š</p>
<p><a href="https://demo-gdb-step-thru-bpf.pages.dev/">https://demo-gdb-step-thru-bpf.pages.dev/</a></p>
<p>ç›´åˆ°ä¸‹ä¸€æ¬¡ğŸ––ã€‚</p>

  </div>

  <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">æ–‡ç« ä½œè€…</span>
    
    <span class="item-content"> Leon Hwang </span>
  </p>
  <p class="copyright-item">
    <span class="item-title">ä¸Šæ¬¡æ›´æ–°</span>
    <span class="item-content">
        2023-05-23
        
    </span>
  </p>
  
  
</div>
<div class="post-reward">
    <img align="center" src="/profile.png" alt="profile.png" style="height: 120px;">
</div><footer class="post-footer">
    <div class="post-tags">
      <a href="/%20tags/ebpf/">eBPF</a>
      <a href="/%20tags/tailcall/">tailcall</a>
      <a href="/%20tags/bpf2bpf/">bpf2bpf</a>
      <a href="/%20tags/x86/">x86</a>
      </div>
    <nav class="post-nav">
      <a class="prev" href="/post/ebpf-talk-34-af_xdp/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">eBPF Talk: ä½¿ç”¨ AF_XDP åŠ é€Ÿç½‘ç»œã€è¯‘ã€‘</span>
        <span class="prev-text nav-mobile">ä¸Šä¸€ç¯‡</span>
      </a>
      <a class="next" href="/post/ebpf-talk-32-tailcall-and-bpf2bpf/">
        <span class="next-text nav-default">eBPF Talk: tailcall ä¸ bpf2bpfã€è¯‘ã€‘</span>
        <span class="next-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav>
  </footer>
</article>
        </div>
        




<script src="https://giscus.app/client.js" data-repo="Asphaltt/asphaltt.github.io"
  data-repo-id="R_kgDOGUj7jQ" data-category="Announcements"
  data-category-id="DIC_kwDOGUj7jc4CSSYW" data-mapping="pathname" data-strict="0"
  data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="dark_dimmed" data-lang="zh-CN"
  data-loading="lazy" crossorigin="anonymous" async>
  </script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/giscus/giscus">comments powered by
    giscus.</a></noscript>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:le0nhwan9@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/LeonHuayra" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://github.com/Asphaltt" class="iconfont icon-github" title="github"></a>
  <a href="https://blog.leonhw.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    ç”± <a class="hexo-link" href="https://gohugo.io">Hugo</a> å¼ºåŠ›é©±åŠ¨
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    ä¸»é¢˜ -
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> æœ¬ç«™æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> æ¬¡ </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> æœ¬ç«™æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> äºº </span>
  </div>

  <span class="copyright-year">
    &copy;
    2021 -
    2026<span class="heart"><i class="iconfont icon-heart"></i></span>
    
    <span> Leon Hwang </span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script><script id="baidu_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?ce3c909090b0d435716d2679ef1989cf";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>






</body>
</html>
