<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Linux 对抗 synflood 的实现 - LeonHwang&#39;s Blogs</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author"
  content="Leon Hwang" /><meta name="description" content="synflood 介绍 synflood 是一种 TCP 半连接攻击，会消耗尽服务器资源从而导致服务器拒绝服务。 参考搜狗百科：syn flood。 Linux 中对抗 synflood 的手段 Linux 中对抗 synflood 的主要手段是" /><meta name="keywords"
  content="Go, eBPF, eBPF Talk, skbtracer, go-nfnetlink, iptables, iptables-nfqueue" />






<meta name="generator" content="Hugo 0.88.1 with theme even" />


<link rel="canonical" href="https://le0nhwan9.github.io/post/linux-how-anti-synflood-works/" />
<link rel="apple-touch-icon" sizes="180x180" href="/%20apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/%20favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/%20favicon-16x16.png">
<link rel="manifest" href="/%20manifest.json">
<link rel="mask-icon" href="/%20safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.b5a744db6de49a86cadafb3b70f555ab443f83c307a483402259e94726b045ff.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Linux 对抗 synflood 的实现" />
<meta property="og:description" content="synflood 介绍 synflood 是一种 TCP 半连接攻击，会消耗尽服务器资源从而导致服务器拒绝服务。 参考搜狗百科：syn flood。 Linux 中对抗 synflood 的手段 Linux 中对抗 synflood 的主要手段是" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://le0nhwan9.github.io/post/linux-how-anti-synflood-works/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-05-19T21:54:30+08:00" />
<meta property="article:modified_time" content="2021-05-19T21:54:30+08:00" />

<meta itemprop="name" content="Linux 对抗 synflood 的实现">
<meta itemprop="description" content="synflood 介绍 synflood 是一种 TCP 半连接攻击，会消耗尽服务器资源从而导致服务器拒绝服务。 参考搜狗百科：syn flood。 Linux 中对抗 synflood 的手段 Linux 中对抗 synflood 的主要手段是"><meta itemprop="datePublished" content="2021-05-19T21:54:30+08:00" />
<meta itemprop="dateModified" content="2021-05-19T21:54:30+08:00" />
<meta itemprop="wordCount" content="1571">
<meta itemprop="keywords" content="Linux,synflood," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Linux 对抗 synflood 的实现"/>
<meta name="twitter:description" content="synflood 介绍 synflood 是一种 TCP 半连接攻击，会消耗尽服务器资源从而导致服务器拒绝服务。 参考搜狗百科：syn flood。 Linux 中对抗 synflood 的手段 Linux 中对抗 synflood 的主要手段是"/>


<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->


<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1873931068599582"
  crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-X2X9EP3K14"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'G-X2X9EP3K14');

  gtag('set', 'linker', {
    'domains': ['asphaltt.github.io', 'le0nhwan9.github.io'],
    'decorate_forms': true
  });
</script>
</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Leon Hwang&#39;s Blogs</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Leon Hwang&#39;s Blogs</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
  
  <header class="post-header">
    <h1 class="post-title">Linux 对抗 synflood 的实现</h1>

    <div class="post-meta">
      <span class="post-time"> 2021-05-19 </span>
      <div class="post-category">
        <a href="/%20categories/linux/"> Linux </a>
        </div>
      <span class="more-meta"> 约 1571 字 </span>
      <span class="more-meta"> 预计阅读 4 分钟 </span>
      <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg" /></span> 次阅读 </span>
    </div>
  </header>

  <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#synflood-介绍">synflood 介绍</a></li>
        <li><a href="#linux-中对抗-synflood-的手段">Linux 中对抗 synflood 的手段</a></li>
        <li><a href="#syncookies-的源代码分析">syncookies 的源代码分析</a>
          <ul>
            <li><a href="#接收-syn-包并响应-synack-包">接收 syn 包并响应 synack 包</a></li>
            <li><a href="#接收-ack-包">接收 ack 包</a></li>
          </ul>
        </li>
        <li><a href="#验证-syncookies-启用的效果">验证 syncookies 启用的效果</a></li>
        <li><a href="#总结">总结</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
  <div class="post-content">
    <h2 id="synflood-介绍">synflood 介绍</h2>
<p>synflood 是一种 TCP 半连接攻击，会消耗尽服务器资源从而导致服务器拒绝服务。</p>
<blockquote>
<p>参考搜狗百科：<a href="https://baike.sogou.com/v846939.htm?fromTitle=syn%20flood">syn flood</a>。</p>
</blockquote>
<h2 id="linux-中对抗-synflood-的手段">Linux 中对抗 synflood 的手段</h2>
<p>Linux 中对抗 synflood 的主要手段是 syn backlog + tcp_syncookies。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">// Documentations/networking/ip-sysctl.txt

tcp_max_syn_backlog - INTEGER
        Maximal number of remembered connection requests, which have not
        received an acknowledgment from connecting client.
        The minimal value is 128 for low memory machines, and it will
        increase in proportion to the memory of machine.
        If server suffers from overload, try increasing this number.

tcp_syncookies - BOOLEAN
        Only valid when the kernel was compiled with CONFIG_SYN_COOKIES
        Send out syncookies when the syn backlog queue of a socket
        overflows. This is to prevent against the common &#39;SYN flood attack&#39;
        Default: 1

        Note, that syncookies is fallback facility.
        It MUST NOT be used to help highly loaded servers to stand
        against legal connection rate. If you see SYN flood warnings
        in your logs, but investigation shows that they occur
        because of overload with legal connections, you should tune
        another parameters until this warning disappear.
        See: tcp_max_syn_backlog, tcp_synack_retries, tcp_abort_on_overflow.

        syncookies seriously violate TCP protocol, do not allow
        to use TCP extensions, can result in serious degradation
        of some services (f.e. SMTP relaying), visible not by you,
        but your clients and relays, contacting you. While you see
        SYN flood warnings in logs not being really flooded, your server
        is seriously misconfigured.

        If you want to test which effects syncookies have to your
        network connections you can set this knob to 2 to enable
        unconditionally generation of syncookies.
</code></pre></td></tr></table>
</div>
</div><p>文档中已说明，当 syn backlog 溢出后就启用 syncookies。</p>
<p>可以通过 <code>sysctl -w net.ipv4.tcp_syncookies=2</code> 强制开启 syncookies。</p>
<h2 id="syncookies-的源代码分析">syncookies 的源代码分析</h2>
<p>syncookies 作用于 tcp 连接握手过程：接收 syn 包、响应 synack 包、接收 ack 包。</p>
<blockquote>
<p>参考：<a href="https://mp.weixin.qq.com/s/GoYDsfy9m0wRoXi_NCfCmg">图解Linux网络包接收过程</a></p>
</blockquote>
<h3 id="接收-syn-包并响应-synack-包">接收 syn 包并响应 synack 包</h3>
<ol>
<li>判断是否启用 syncookies</li>
<li>新建处理 syn 包的 req 对象时，req 对象不绑定 listener 对象</li>
<li>响应 synack 创建 skb 对象时并不 hold 住该 skb 对象</li>
<li>释放 req 对象</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="c1">// net/ipv4/tcp_input.c
</span><span class="c1"></span>
<span class="c1">// tcp_v4_rcv -&gt; tcp_v4_do_rcv -&gt; tcp_rcv_state_process -&gt; tcp_v4_conn_request -&gt; tcp_conn_request
</span><span class="c1"></span>
<span class="kt">int</span> <span class="nf">tcp_conn_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_sock_ops</span> <span class="o">*</span><span class="n">rsk_ops</span><span class="p">,</span>
       <span class="k">const</span> <span class="k">struct</span> <span class="n">tcp_request_sock_ops</span> <span class="o">*</span><span class="n">af_ops</span><span class="p">,</span>
       <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="p">...</span>
  <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">want_cookie</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">...</span>

  <span class="c1">// 判断是否启用 syncookies
</span><span class="c1"></span>  <span class="c1">// tcp_syncookies=2 就是强制启用 syncookies，忽略 syn backlog
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">((</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">sysctl_tcp_syncookies</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span>
      <span class="n">inet_csk_reqsk_queue_is_full</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isn</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">want_cookie</span> <span class="o">=</span> <span class="n">tcp_syn_flood_action</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">rsk_ops</span><span class="o">-&gt;</span><span class="n">slab_name</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">want_cookie</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
  <span class="p">}</span>

 <span class="p">...</span>

  <span class="c1">// 处理 syn 包的 struct sock 对象
</span><span class="c1"></span>  <span class="c1">// !want_cookie 是不将 req 跟 listener 相互绑定起来，响应 synack 后会释放掉 req 对象，从而减少服务器的资源占用
</span><span class="c1"></span>  <span class="n">req</span> <span class="o">=</span> <span class="n">inet_reqsk_alloc</span><span class="p">(</span><span class="n">rsk_ops</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="o">!</span><span class="n">want_cookie</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
    <span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

  <span class="n">req</span><span class="o">-&gt;</span><span class="n">syncookie</span> <span class="o">=</span> <span class="n">want_cookie</span><span class="p">;</span>
 <span class="p">...</span>

 <span class="k">if</span> <span class="p">(</span><span class="n">want_cookie</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">isn</span> <span class="o">=</span> <span class="n">cookie_init_sequence</span><span class="p">(</span><span class="n">af_ops</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">mss</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_opt</span><span class="p">.</span><span class="n">tstamp_ok</span><span class="p">)</span>
   <span class="n">inet_rsk</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ecn_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="p">}</span>

 <span class="p">...</span>

 <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">want_cookie</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">tcp_reqsk_record_syn</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
  <span class="n">fastopen_sk</span> <span class="o">=</span> <span class="n">tcp_try_fastopen</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">foc</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
 <span class="p">}</span>
 <span class="k">if</span> <span class="p">(</span><span class="n">fastopen_sk</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">af_ops</span><span class="o">-&gt;</span><span class="n">send_synack</span><span class="p">(</span><span class="n">fastopen_sk</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="n">foc</span><span class="p">,</span> <span class="n">TCP_SYNACK_FASTOPEN</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
  <span class="p">...</span>
 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="n">tcp_rsk</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tfo_listener</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">want_cookie</span><span class="p">)</span> <span class="c1">// 不启用 syncookies，则将 req 加入到 syn backlog
</span><span class="c1"></span>   <span class="n">inet_csk_reqsk_queue_hash_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
    <span class="n">tcp_timeout_init</span><span class="p">((</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="p">));</span>
    <span class="c1">// 发送 synack 包
</span><span class="c1"></span>  <span class="n">af_ops</span><span class="o">-&gt;</span><span class="n">send_synack</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">foc</span><span class="p">,</span>
        <span class="o">!</span><span class="n">want_cookie</span> <span class="o">?</span> <span class="nl">TCP_SYNACK_NORMAL</span> <span class="p">:</span>
         <span class="n">TCP_SYNACK_COOKIE</span><span class="p">,</span>
        <span class="n">skb</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">want_cookie</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 发送 synack 包后，释放掉 req
</span><span class="c1"></span>      <span class="c1">// 当发生 synflood 时，释放 req 是为了减少服务器资源占用
</span><span class="c1"></span>   <span class="n">reqsk_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
 <span class="p">}</span>

 <span class="p">...</span>
 <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

  <span class="p">...</span>
<span class="p">}</span>


<span class="c1">// net/ipv4/tcp_input.c
</span><span class="c1"></span>
<span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="nf">inet_reqsk_alloc</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">request_sock_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span>
          <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk_listener</span><span class="p">,</span>
          <span class="kt">bool</span> <span class="n">attach_listener</span><span class="p">)</span>
<span class="p">{</span>
 <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">reqsk_alloc</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span> <span class="n">sk_listener</span><span class="p">,</span>
            <span class="n">attach_listener</span><span class="p">);</span>

 <span class="p">...</span>

 <span class="k">return</span> <span class="n">req</span><span class="p">;</span>
<span class="p">}</span>


<span class="c1">// include/net/request_sock.h
</span><span class="c1"></span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span>
<span class="nf">reqsk_alloc</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">request_sock_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk_listener</span><span class="p">,</span>
     <span class="kt">bool</span> <span class="n">attach_listener</span><span class="p">)</span>
<span class="p">{</span>
 <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

 <span class="n">req</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">slab</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span> <span class="o">|</span> <span class="n">__GFP_NOWARN</span><span class="p">);</span>
 <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

 <span class="n">req</span><span class="o">-&gt;</span><span class="n">rsk_listener</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="k">if</span> <span class="p">(</span><span class="n">attach_listener</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// syncookie 启用时，attach_listener 为 false
</span><span class="c1"></span>  <span class="p">...</span>
  <span class="n">req</span><span class="o">-&gt;</span><span class="n">rsk_listener</span> <span class="o">=</span> <span class="n">sk_listener</span><span class="p">;</span>
 <span class="p">}</span>
 <span class="p">...</span>

 <span class="k">return</span> <span class="n">req</span><span class="p">;</span>
<span class="p">}</span>


<span class="c1">// net/ipv4/tcp_ipv4.c
</span><span class="c1"></span>
<span class="c1">// af_ops-&gt;send_synack
</span><span class="c1"></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">tcp_v4_send_synack</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
         <span class="k">struct</span> <span class="n">flowi</span> <span class="o">*</span><span class="n">fl</span><span class="p">,</span>
         <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
         <span class="k">struct</span> <span class="n">tcp_fastopen_cookie</span> <span class="o">*</span><span class="n">foc</span><span class="p">,</span>
         <span class="k">enum</span> <span class="n">tcp_synack_type</span> <span class="n">synack_type</span><span class="p">,</span>
         <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">syn_skb</span><span class="p">)</span>
<span class="p">{</span>
 <span class="p">...</span>
 <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

 <span class="p">...</span>

 <span class="n">skb</span> <span class="o">=</span> <span class="n">tcp_make_synack</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">synack_type</span><span class="p">,</span> <span class="n">syn_skb</span><span class="p">);</span>

 <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
 <span class="p">}</span>

 <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="c1">/// net/ipv4/tcp_output.c
</span><span class="c1"></span>
<span class="cm">/**
</span><span class="cm"> * tcp_make_synack - 分配一个 skb 并构建一个 SYNACK 包
</span><span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">tcp_make_synack</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">tcp_fastopen_cookie</span> <span class="o">*</span><span class="n">foc</span><span class="p">,</span>
    <span class="k">enum</span> <span class="n">tcp_synack_type</span> <span class="n">synack_type</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">syn_skb</span><span class="p">)</span>
<span class="p">{</span>
 <span class="p">...</span>
 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
 <span class="p">...</span>

 <span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">MAX_TCP_HEADER</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
 <span class="p">...</span>

 <span class="k">switch</span> <span class="p">(</span><span class="n">synack_type</span><span class="p">)</span> <span class="p">{</span>
 <span class="k">case</span> <span class="nl">TCP_SYNACK_NORMAL</span><span class="p">:</span>
  <span class="n">skb_set_owner_w</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">req_to_sk</span><span class="p">(</span><span class="n">req</span><span class="p">));</span>
  <span class="k">break</span><span class="p">;</span>

 <span class="k">case</span> <span class="nl">TCP_SYNACK_COOKIE</span><span class="p">:</span>
  <span class="c1">// synflood 攻击时，skb 对象不绑定 socket 是为了减少服务器资源占用
</span><span class="c1"></span>  <span class="k">break</span><span class="p">;</span>

 <span class="k">case</span> <span class="nl">TCP_SYNACK_FASTOPEN</span><span class="p">:</span>
  <span class="n">skb_set_owner_w</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="p">)</span><span class="n">sk</span><span class="p">);</span>
  <span class="k">break</span><span class="p">;</span>
 <span class="p">}</span>
 <span class="p">...</span>

 <span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="接收-ack-包">接收 ack 包</h3>
<ol>
<li>取出 socket 对象（忽略这一步的分析）</li>
<li>检查 ack 包中的 cookie</li>
<li>创建处理 ack 包的 req 对象和 sock 对象</li>
<li>处理 tcp 连接状态</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="c1">// net/ipv4/tcp_ipv4.c
</span><span class="c1"></span>
<span class="kt">int</span> <span class="nf">tcp_v4_do_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
 <span class="p">...</span>

 <span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_LISTEN</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">nsk</span> <span class="o">=</span> <span class="n">tcp_v4_cookie_check</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

  <span class="p">...</span>
 <span class="p">}</span> <span class="k">else</span>
  <span class="p">...</span>

 <span class="k">if</span> <span class="p">(</span><span class="n">tcp_rcv_state_process</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">rsk</span> <span class="o">=</span> <span class="n">sk</span><span class="p">;</span>
  <span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
 <span class="p">}</span>
 <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

  <span class="p">...</span>
<span class="p">}</span>


<span class="c1">// net/ipv4/tcp_ipv4.c
</span><span class="c1"></span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">tcp_v4_cookie_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
 <span class="k">const</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">th</span> <span class="o">=</span> <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
 <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">syn</span><span class="p">)</span>
  <span class="n">sk</span> <span class="o">=</span> <span class="n">cookie_v4_check</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

 <span class="k">return</span> <span class="n">sk</span><span class="p">;</span>
<span class="p">}</span>


<span class="c1">// net/ipv4/syncookies.c
</span><span class="c1"></span>
<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">cookie_v4_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
 <span class="p">...</span>
 <span class="kt">int</span> <span class="n">mss</span><span class="p">;</span>
 <span class="n">mss</span> <span class="o">=</span> <span class="n">__cookie_v4_check</span><span class="p">(</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">th</span><span class="p">,</span> <span class="n">cookie</span><span class="p">);</span>
 <span class="k">if</span> <span class="p">(</span><span class="n">mss</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
 <span class="p">}</span>

 <span class="n">req</span> <span class="o">=</span> <span class="n">cookie_tcp_reqsk_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_request_sock_ops</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
 <span class="p">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="验证-syncookies-启用的效果">验证 syncookies 启用的效果</h2>
<p>调用函数 __cookie_v4_check 可以校验一个 ack 包是否为 syncookies 包，同时可以得到 mss（Max Segment Size：tcp 最大分片大小）。</p>
<p>编写一个 <code>netfilter PREROUTING hook</code> 对 ack 包进行校验。效果如下：</p>
<p><img src="/linux%20synflood.png" alt="syncookie"></p>
<blockquote>
<p>内核模块源代码：<a href="https://github.com/Asphaltt/kernel-module-fun/blob/master/check-tcp-syncookies.c">kernel-module-fun</a></p>
</blockquote>
<h2 id="总结">总结</h2>
<p>启用 syncookies 虽能减少服务器的资源消耗，却破坏了服务端正常处理 tcp 握手的过程。所以在非 synflood 的场景下，不推荐强制启用 syncookies。</p>

  </div>

  <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Leon Hwang</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2021-05-19
        
    </span>
  </p>
  
  
</div>
<div class="post-reward">
    <input type="checkbox" name="telegram" id="reward" hidden />
    <label class="reward-button" for="reward">Telegram</label>
    <div class="qr-code">
        <a href="https://t.me/+3lPhRkGCSuJmYzNl" target="_blank" class="telegram-close" title="Telegram Channel"> 订阅
            Telegram Channel </a> <br />
        
        <label class="qr-code-image" for="telegram">
            <img class="image" src="/TelegramChannel.jpg">
            
        </label>
    </div>
</div><footer class="post-footer">
    <div class="post-tags">
      <a href="/%20tags/linux/">Linux</a>
      <a href="/%20tags/synflood/">synflood</a>
      </div>
    <nav class="post-nav">
      <a class="prev" href="/post/skbtracer/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">skbtracer: Linux 内核网络包路径追踪利器</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
      <a class="next" href="/post/linux-custom-netfilter-hook-experiment/">
        <span class="next-text nav-default">Linux 自定义 netfilter 钩子实验</span>
        <span class="next-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav>
  </footer>
</article>
        </div>
        




<script src="https://giscus.app/client.js" data-repo="Asphaltt/asphaltt.github.io"
  data-repo-id="R_kgDOGUj7jQ" data-category="Announcements"
  data-category-id="DIC_kwDOGUj7jc4CSSYW" data-mapping="pathname" data-strict="0"
  data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="dark_dimmed" data-lang="zh-CN"
  data-loading="lazy" crossorigin="anonymous" async>
  </script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/giscus/giscus">comments powered by
    giscus.</a></noscript>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:le0nhwan9@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/LeonHuayra" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://github.com/Asphaltt" class="iconfont icon-github" title="github"></a>
  <a href="https://le0nhwan9.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2021 - 
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span>Leon Hwang</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>

<script id="baidu_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?ce3c909090b0d435716d2679ef1989cf";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>






</body>
</html>
