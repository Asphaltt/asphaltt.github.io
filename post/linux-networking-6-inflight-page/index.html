<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Linux 网络：让 page 飞 - LeonHwang&#39;s Blogs</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author"
  content="" /><meta name="description" content="在努力排查一个网络设备相关的问题；终不负期望，排查出根因了。 现象是 dmesg 里不停地打印以下日志： 1 page_pool_release_retry() stalled pool shutdown 1 inflight 2899 sec 根因：Kafka Go library IBM/sarama 存在 tcp 连接" /><meta name="keywords"
  content="Go, eBPF, eBPF Talk, skbtracer, go-nfnetlink, iptables, iptables-nfqueue" />






<meta name="generator" content="Hugo 0.125.0-DEV with theme even" />


<link rel="canonical" href="https://blog.leonhw.com/post/linux-networking-6-inflight-page/" />
<link rel="apple-touch-icon" sizes="180x180" href="/%20apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/%20favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/%20favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.e319aa82b43bd5b3901ce5d09fd243a802bbfb6a468c088e063c7136d36ae4a7.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Linux 网络：让 page 飞" />
<meta property="og:description" content="在努力排查一个网络设备相关的问题；终不负期望，排查出根因了。 现象是 dmesg 里不停地打印以下日志： 1 page_pool_release_retry() stalled pool shutdown 1 inflight 2899 sec 根因：Kafka Go library IBM/sarama 存在 tcp 连接" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.leonhw.com/post/linux-networking-6-inflight-page/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2025-11-23T23:32:18+08:00" />
<meta property="article:modified_time" content="2025-11-23T23:32:18+08:00" />

  <meta itemprop="name" content="Linux 网络：让 page 飞">
  <meta itemprop="description" content="在努力排查一个网络设备相关的问题；终不负期望，排查出根因了。 现象是 dmesg 里不停地打印以下日志： 1 page_pool_release_retry() stalled pool shutdown 1 inflight 2899 sec 根因：Kafka Go library IBM/sarama 存在 tcp 连接">
  <meta itemprop="datePublished" content="2025-11-23T23:32:18+08:00">
  <meta itemprop="dateModified" content="2025-11-23T23:32:18+08:00">
  <meta itemprop="wordCount" content="6953">
  <meta itemprop="keywords" content="Linux,Page_pool,Bpfsnoop,Tcp"><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Linux 网络：让 page 飞"/>
<meta name="twitter:description" content="在努力排查一个网络设备相关的问题；终不负期望，排查出根因了。 现象是 dmesg 里不停地打印以下日志： 1 page_pool_release_retry() stalled pool shutdown 1 inflight 2899 sec 根因：Kafka Go library IBM/sarama 存在 tcp 连接"/>


<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->


<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1873931068599582"
  crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-X2X9EP3K14"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'G-X2X9EP3K14');

  gtag('set', 'linker', {
    'domains': ['asphaltt.github.io', 'le0nhwan9.github.io'],
    'decorate_forms': true
  });
</script>
</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Leon Hwang&#39;s Blogs</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Leon Hwang&#39;s Blogs</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
  
  <header class="post-header">
    <h1 class="post-title">Linux 网络：让 page 飞</h1>

    <div class="post-meta">
      <span class="post-time"> 2025-11-23 </span>
      <div class="post-category">
        <a href="/%20categories/linux/"> Linux </a>
        </div>
      <span class="more-meta"> 约 6953 字 </span>
      <span class="more-meta"> 预计阅读 14 分钟 </span>
      <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg" /></span> 次阅读 </span>
    </div>
  </header>

  <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-复现问题">1. 复现问题</a>
          <ul>
            <li><a href="#11-关掉网络设备发生了什么">1.1. 关掉网络设备发生了什么？</a></li>
            <li><a href="#12-为什么要等-1-分钟">1.2. 为什么要等 1 分钟？</a></li>
            <li><a href="#13-等-1-分钟dmesg-里可能没有日志">1.3. 等 1 分钟，dmesg 里可能没有日志</a></li>
            <li><a href="#14-排查的转折点">1.4. 排查的转折点</a></li>
          </ul>
        </li>
        <li><a href="#2-协议栈行为分析">2. 协议栈行为分析</a>
          <ul>
            <li><a href="#21-__tcp_close-为什么会释放-skb">2.1. <code>__tcp_close()</code> 为什么会释放 skb？</a></li>
            <li><a href="#22-__kfree_skb-是如何归还-page-的">2.2. <code>__kfree_skb()</code> 是如何归还 page 的？</a></li>
            <li><a href="#23-尝试-bpf-的-itertcp">2.3. 尝试 bpf 的 <code>iter/tcp</code></a></li>
            <li><a href="#24-使用内核模块遍历-tcp-socket">2.4. 使用内核模块遍历 tcp socket</a></li>
            <li><a href="#25-socket-变成-tcp_close-的原因">2.5. socket 变成 <code>TCP_CLOSE</code> 的原因</a></li>
          </ul>
        </li>
        <li><a href="#3-sarama-存在-tcp-连接泄漏问题">3. sarama 存在 tcp 连接泄漏问题</a>
          <ul>
            <li><a href="#31-给-sarama-加更多-log">3.1. 给 sarama 加更多 log</a></li>
            <li><a href="#32-修复-sarama">3.2. 修复 sarama</a></li>
          </ul>
        </li>
        <li><a href="#4-改进内核协议栈">4. 改进内核协议栈</a>
          <ul>
            <li><a href="#41-计划新增-netipv4tcp_purge_receive_queue-sysctl">4.1. 计划新增 <code>net.ipv4.tcp_purge_receive_queue</code> sysctl</a></li>
            <li><a href="#42-计划新增-page_pool_release_stalled-tracepoint">4.2. 计划新增 <code>page_pool_release_stalled</code> tracepoint</a></li>
          </ul>
        </li>
        <li><a href="#5-小结">5. 小结</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
  <div class="post-content">
    <p>在努力排查一个网络设备相关的问题；终不负期望，排查出根因了。</p>
<p>现象是 <code>dmesg</code> 里不停地打印以下日志：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">page_pool_release_retry() stalled pool shutdown 1 inflight 2899 sec
</span></span></code></pre></td></tr></table>
</div>
</div><p>根因：Kafka Go library <a href="https://github.com/IBM/sarama">IBM/sarama</a> 存在 tcp 连接泄漏问题（<a href="https://github.com/IBM/sarama/issues/3143">Client SeekBroker Connection Leak</a>）。</p>
<p>TL;DR 泄漏的 tcp 连接导致 page pool 无法回收 page 的因果链：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">sarama 发生 tcp 连接泄漏
</span></span><span class="line"><span class="cl"> → TCP sockets 一直处于 TCP_CLOSE 状态
</span></span><span class="line"><span class="cl">   → sockets sk_receive_queues 缓存了 FINACK skb
</span></span><span class="line"><span class="cl">     → 那些 skb 引用这从 page pool 分配出来的 page
</span></span><span class="line"><span class="cl">       → page_pool_release_retry() 尝试回收 page 失败
</span></span><span class="line"><span class="cl">         → page_pool_release_retry() 不断尝试回收，不断失败
</span></span><span class="line"><span class="cl">           → 往 dmesg 里打印 log
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="1-复现问题">1. 复现问题</h2>
<p>发现问题的机器使用的是 Mellanox 网卡；反复尝试后，发现只需要 <code>ip link set dev eth0 down</code> 即可，然后等 1 分钟查看 <code>dmesg</code> 里是否出现 log。</p>
<h3 id="11-关掉网络设备发生了什么">1.1. 关掉网络设备发生了什么？</h3>
<ol>
<li>网络驱动在销毁队列时，向 page pool 归还 page：<code>page_pool_put_defragged_page()</code>。</li>
<li>释放 page pool：<code>page_pool_destroy()</code>。</li>
<li>如果有 inflight page，则启动 worker 定期（每秒）通过 <code>page_pool_release_retry()</code> 尝试回收 page 并释放 page pool。</li>
</ol>
<h3 id="12-为什么要等-1-分钟">1.2. 为什么要等 1 分钟？</h3>
<p>直接查看 <code>page_pool_release_retry()</code> 的源代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// net/core/page_pool.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define DEFER_WARN_INTERVAL (60 * HZ)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">page_pool_release_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">dwq</span> <span class="o">=</span> <span class="nf">to_delayed_work</span><span class="p">(</span><span class="n">wq</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">page_pool</span> <span class="o">*</span><span class="n">pool</span> <span class="o">=</span> <span class="nf">container_of</span><span class="p">(</span><span class="n">dwq</span><span class="p">,</span> <span class="nf">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">pool</span><span class="p">),</span> <span class="n">release_dw</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">inflight</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">inflight</span> <span class="o">=</span> <span class="nf">page_pool_release</span><span class="p">(</span><span class="n">pool</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* In rare cases, a driver bug may cause inflight to go negative.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Don&#39;t reschedule release if inflight is 0 or negative.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * - If 0, the page_pool has been destroyed
</span></span></span><span class="line"><span class="cl"><span class="cm">     * - if negative, we will never recover
</span></span></span><span class="line"><span class="cl"><span class="cm">     * in both cases no reschedule is necessary.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">inflight</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Periodic warning */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">defer_warn</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">sec</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">)((</span><span class="n">u32</span><span class="p">)</span><span class="n">jiffies</span> <span class="o">-</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">defer_start</span><span class="p">)</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">pr_warn</span><span class="p">(</span><span class="s">&#34;%s() stalled pool shutdown %d inflight %d sec</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">__func__</span><span class="p">,</span> <span class="n">inflight</span><span class="p">,</span> <span class="n">sec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span><span class="o">-&gt;</span><span class="n">defer_warn</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">DEFER_WARN_INTERVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Still not ready to be disconnected, retry later */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">release_dw</span><span class="p">,</span> <span class="n">DEFER_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中，只有超过 <code>pool-&gt;defer_warn</code> （1 分钟）时才会打印日志；所以当 <code>page_pool_release_retry()</code> 第一次运行时，并不会打印日志。</p>
<p>而且：</p>
<ol>
<li>在第 1 分钟，大概率能回收不少 page；因此，在第 1 分钟内打印日志毫无意义，还会造成噪音。</li>
<li>Jason Xing 大佬加的 <code>if (inflight &lt;= 0)</code> 优化并没有起作用，因为 <code>inflight</code> 大于 0，真的有 page 还没归还。</li>
</ol>
<h3 id="13-等-1-分钟dmesg-里可能没有日志">1.3. 等 1 分钟，dmesg 里可能没有日志</h3>
<p>在查出更多细节前，并不知道还有没有 page 没归还。</p>
<h3 id="14-排查的转折点">1.4. 排查的转折点</h3>
<p>即使咨询 AI，大部分时候都无济于事；AI 能提供思路和方向，但作用不大。</p>
<p>在 <code>page_pool.c</code> 里，有 2 个 tracepoint 能用来跟踪 page 的分配和回收情况：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># bpfsnoop --show-func-proto -t &#39;page_pool_state_*&#39;</span>
</span></span><span class="line"><span class="cl">Kernel tracepoints: <span class="o">(</span>total 2<span class="o">)</span>
</span></span><span class="line"><span class="cl">void page_pool_state_hold<span class="o">(</span>const struct page_pool *pool, const struct page *page, u32 hold<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">void page_pool_state_release<span class="o">(</span>const struct page_pool *pool, const struct page *page, u32 release<span class="o">)</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>但是，即使通过这 2 个 tracepoint 分析出哪些 page 还没回收，还是无法知道那些 page 还没回收的原因。</p>
<p>【进展】持续观察 dmesg，发现一段时间后那些日志会减少、甚至不再打印日志。</p>
<p>也就是说：在这过程中，有 page 被归还并回收掉了。</p>
<p>下一步，祭出 bpfsnoop：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># bpfsnoop \</span>
</span></span><span class="line"><span class="cl">    -k <span class="s1">&#39;(s)page_pool_put_*&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -t <span class="s1">&#39;(s)page_pool_state_*&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --filter-arg <span class="s1">&#39;pool-&gt;destroy_cnt &gt; 1&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --output-arg <span class="s1">&#39;pool-&gt;destroy_cnt&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --output-arg <span class="s1">&#39;pool-&gt;pages_state_hold_cnt&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --output-arg <span class="s1">&#39;pool-&gt;pages_state_release_cnt.counter&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --output-arg <span class="s1">&#39;*page&#39;</span> -o inflight_page.bpfsnoop.log
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">← page_pool_put_defragged_page <span class="nv">args</span><span class="o">=((</span>struct page_pool *<span class="o">)</span><span class="nv">pool</span><span class="o">=</span>0xff110001fde50800, <span class="o">(</span>struct page *<span class="o">)</span><span class="nv">page</span><span class="o">=</span>0xffd4000007fc18c0, <span class="o">(</span>unsigned int<span class="o">)</span><span class="nv">dma_sync_size</span><span class="o">=</span>0xffffffff/4294967295, <span class="o">(</span>bool<span class="o">)</span><span class="nv">allow_direct</span><span class="o">=</span><span class="nb">false</span><span class="o">)</span> <span class="nv">retval</span><span class="o">=(</span>void<span class="o">)</span> <span class="nv">cpu</span><span class="o">=</span><span class="m">22</span> <span class="nv">process</span><span class="o">=(</span>262275:xxx-agent<span class="o">)</span> <span class="nv">timestamp</span><span class="o">=</span>17:39:16.551295117
</span></span><span class="line"><span class="cl">Arg attrs: <span class="o">(</span>u64<span class="o">)</span><span class="s1">&#39;pool-&gt;destroy_cnt&#39;</span><span class="o">=</span>0x45/69, <span class="o">(</span>u32<span class="o">)</span><span class="s1">&#39;pool-&gt;pages_state_hold_cnt&#39;</span><span class="o">=</span>0x1000/4096, <span class="o">(</span>int<span class="o">)</span><span class="s1">&#39;pool-&gt;pages_state_release_cnt.counter&#39;</span><span class="o">=</span>4095, <span class="o">(</span>struct page<span class="o">)</span><span class="s1">&#39;*page&#39;</span><span class="o">={</span><span class="s2">&#34;flags&#34;</span>: 6755398367313920, <span class="s2">&#34;&#34;</span>: <span class="o">{</span><span class="s2">&#34;&#34;</span>: <span class="o">{</span><span class="s2">&#34;&#34;</span>: <span class="o">{</span><span class="s2">&#34;lru&#34;</span>: <span class="o">{</span><span class="s2">&#34;next&#34;</span>: 0xdead000000000040, <span class="s2">&#34;prev&#34;</span>: 0xff110001fde50800<span class="o">}</span>, <span class="s2">&#34;&#34;</span>: <span class="o">{</span><span class="s2">&#34;__filler&#34;</span>: 0xdead000000000040, <span class="s2">&#34;mlock_count&#34;</span>: 4259645440<span class="o">}</span>, <span class="s2">&#34;buddy_list&#34;</span>: <span class="o">{</span><span class="s2">&#34;next&#34;</span>: 0xdead000000000040, <span class="s2">&#34;prev&#34;</span>: 0xff110001fde50800<span class="o">}</span>, <span class="s2">&#34;pcp_list&#34;</span>: <span class="o">{</span><span class="s2">&#34;next&#34;</span>: 0xdead000000000040, <span class="s2">&#34;prev&#34;</span>: 0xff110001fde50800<span class="o">}}</span>, <span class="s2">&#34;mapping&#34;</span>: 0x0, <span class="s2">&#34;&#34;</span>: <span class="o">{</span><span class="s2">&#34;index&#34;</span>: 8573562880, <span class="s2">&#34;share&#34;</span>: 8573562880<span class="o">}</span>, <span class="s2">&#34;private&#34;</span>: 1<span class="o">}</span>, <span class="s2">&#34;&#34;</span>: <span class="o">{</span><span class="s2">&#34;pp_magic&#34;</span>: 16045481047390945344, <span class="s2">&#34;pp&#34;</span>: 0xff110001fde50800, <span class="s2">&#34;_pp_mapping_pad&#34;</span>: 0, <span class="s2">&#34;dma_addr&#34;</span>: 8573562880, <span class="s2">&#34;&#34;</span>: <span class="o">{</span><span class="s2">&#34;dma_addr_upper&#34;</span>: 1, <span class="s2">&#34;pp_frag_count&#34;</span>: <span class="o">{</span><span class="s2">&#34;counter&#34;</span>: 1<span class="o">}}}</span>, <span class="s2">&#34;&#34;</span>: <span class="o">{</span><span class="s2">&#34;compound_head&#34;</span>: 16045481047390945344<span class="o">}</span>, <span class="s2">&#34;&#34;</span>: <span class="o">{</span><span class="s2">&#34;pgmap&#34;</span>: 0xdead000000000040, <span class="s2">&#34;zone_device_data&#34;</span>: 0xff110001fde50800<span class="o">}</span>, <span class="s2">&#34;callback_head&#34;</span>: <span class="o">{</span><span class="s2">&#34;next&#34;</span>: 0xdead000000000040, <span class="s2">&#34;func&#34;</span>: 0xff110001fde50800<span class="o">}}</span>, <span class="s2">&#34;&#34;</span>: <span class="o">{</span><span class="s2">&#34;_mapcount&#34;</span>: <span class="o">{</span><span class="s2">&#34;counter&#34;</span>: -1<span class="o">}</span>, <span class="s2">&#34;page_type&#34;</span>: 4294967295<span class="o">}</span>, <span class="s2">&#34;_refcount&#34;</span>: <span class="o">{</span><span class="s2">&#34;counter&#34;</span>: 1<span class="o">}</span>, <span class="s2">&#34;memcg_data&#34;</span>: 0<span class="o">}</span>
</span></span><span class="line"><span class="cl">Func stack:
</span></span><span class="line"><span class="cl">  page_pool_put_defragged_page+0x5                      <span class="p">;</span> net/core/page_pool.c:640
</span></span><span class="line"><span class="cl">  skb_free_head+0x55                                    <span class="p">;</span> net/core/skbuff.c:953
</span></span><span class="line"><span class="cl">  skb_release_data+0x159                                <span class="p">;</span> net/core/skbuff.c:998
</span></span><span class="line"><span class="cl">  __kfree_skb+0x2b                                      <span class="p">;</span> net/core/skbuff.c:1068
</span></span><span class="line"><span class="cl">  __tcp_close+0x93                                      <span class="p">;</span> include/linux/skbuff.h:2065
</span></span><span class="line"><span class="cl">  inet_release+0x44                                     <span class="p">;</span> net/ipv4/af_inet.c:435
</span></span><span class="line"><span class="cl">  __sock_release+0x40                                   <span class="p">;</span> net/socket.c:660
</span></span><span class="line"><span class="cl">  sock_close+0x15                                       <span class="p">;</span> net/socket.c:1423
</span></span><span class="line"><span class="cl">  __fput+0xfe                                           <span class="p">;</span> fs/file_table.c:385
</span></span><span class="line"><span class="cl">  ____fput+0xe                                          <span class="p">;</span> fs/file_table.c:413
</span></span><span class="line"><span class="cl">  task_work_run+0x65                                    <span class="p">;</span> arch/x86/include/asm/jump_label.h:27
</span></span><span class="line"><span class="cl">  do_exit+0x298                                         <span class="p">;</span> kernel/exit.c:884
</span></span><span class="line"><span class="cl">  do_group_exit+0x35                                    <span class="p">;</span> kernel/exit.c:1006
</span></span><span class="line"><span class="cl">  get_signal+0x95f                                      <span class="p">;</span> kernel/signal.c:2902
</span></span><span class="line"><span class="cl">  arch_do_signal_or_restart+0x39
</span></span><span class="line"><span class="cl">  exit_to_user_mode_loop+0x9a                           <span class="p">;</span> kernel/entry/common.c:176
</span></span><span class="line"><span class="cl">  exit_to_user_mode_prepare+0xa5                        <span class="p">;</span> kernel/entry/common.c:210
</span></span><span class="line"><span class="cl">  syscall_exit_to_user_mode+0x29
</span></span><span class="line"><span class="cl">  do_syscall_64+0x62                                    <span class="p">;</span> arch/x86/entry/common.c:88
</span></span><span class="line"><span class="cl">  entry_SYSCALL_64_after_hwframe+0x78                   <span class="p">;</span> arch/x86/entry/entry_64.S:121
</span></span></code></pre></td></tr></table>
</div>
</div><p>一段时间后，分析 bpfsnoop 日志文件，发现如上调用栈：有 page 是在 socket 释放时通过 <code>__kfree_skb()</code> 释放的。</p>
<h2 id="2-协议栈行为分析">2. 协议栈行为分析</h2>
<p>从如上调用栈看，涉及 tcp socket，特别是释放 tcp socket 阶段。</p>
<h3 id="21-__tcp_close-为什么会释放-skb">2.1. <code>__tcp_close()</code> 为什么会释放 skb？</h3>
<p>直接查看 <code>__tcp_close()</code> 的源代码，看看为什么会调用 <code>__kfree_skb()</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// net/ipv4/tcp.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">__tcp_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">data_was_unread</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">WRITE_ONCE</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span><span class="p">,</span> <span class="n">SHUTDOWN_MASK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_LISTEN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">tcp_set_state</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">TCP_CLOSE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Special case. */</span>
</span></span><span class="line"><span class="cl">        <span class="nf">inet_csk_listen_stop</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">adjudge_to_death</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*  We need to flush the recv. buffs.  We do this only on the
</span></span></span><span class="line"><span class="cl"><span class="cm">     *  descriptor close, not protocol-sourced closes, because the
</span></span></span><span class="line"><span class="cl"><span class="cm">     *  reader process may not have drained the data yet!
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="nf">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="nf">TCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">end_seq</span> <span class="o">-</span> <span class="nf">TCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">TCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tcp_flags</span> <span class="o">&amp;</span> <span class="n">TCPHDR_FIN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">len</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_was_unread</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* If socket has been already reset (e.g. in tcp_reset()) - kill it. */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_CLOSE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">adjudge_to_death</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*...*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">out</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nf">bh_unlock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">local_bh_enable</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>原来是在清理 <code>sk-&gt;sk_receive_queue</code>。</p>
<h3 id="22-__kfree_skb-是如何归还-page-的">2.2. <code>__kfree_skb()</code> 是如何归还 page 的？</h3>
<p>上面调用栈提供的信息并不能说明 <code>__kfree_skb()</code> 会归还 page 的原因。</p>
<p>直接深挖 <code>__kfree_skb()</code> 的源代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// net/core/skb.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">__kfree_skb()
</span></span></span><span class="line"><span class="cl"><span class="cm">|--&gt;skb_release_all()
</span></span></span><span class="line"><span class="cl"><span class="cm">    |--&gt;skb_release_data()
</span></span></span><span class="line"><span class="cl"><span class="cm">        |--&gt;skb_free_head()
</span></span></span><span class="line"><span class="cl"><span class="cm">            |--&gt;skb_pp_recycle()
</span></span></span><span class="line"><span class="cl"><span class="cm">                |--&gt;napi_pp_put_page()
</span></span></span><span class="line"><span class="cl"><span class="cm">                    |--&gt;page_pool_put_full_page()
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">__kfree_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">skb_release_all</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">SKB_DROP_REASON_NOT_SPECIFIED</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">kfree_skbmem</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__kfree_skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Free everything but the sk_buff shell. */</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">skb_release_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">enum</span> <span class="n">skb_drop_reason</span> <span class="n">reason</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="kt">bool</span> <span class="n">napi_safe</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">skb_release_head_state</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">likely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nf">skb_release_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">napi_safe</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">skb_release_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">enum</span> <span class="n">skb_drop_reason</span> <span class="n">reason</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="kt">bool</span> <span class="n">napi_safe</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">skb_shared_info</span> <span class="o">*</span><span class="n">shinfo</span> <span class="o">=</span> <span class="nf">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cloned</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">atomic_sub_return</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">nohdr</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SKB_DATAREF_SHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="o">&amp;</span><span class="n">shinfo</span><span class="o">-&gt;</span><span class="n">dataref</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">skb_zcopy</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">skip_unref</span> <span class="o">=</span> <span class="n">shinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKBFL_MANAGED_FRAG_REFS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">skb_zcopy_clear</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">skip_unref</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">free_head</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">shinfo</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">napi_frag_unref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shinfo</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">pp_recycle</span><span class="p">,</span> <span class="n">napi_safe</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">free_head</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">shinfo</span><span class="o">-&gt;</span><span class="n">frag_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">kfree_skb_list_reason</span><span class="p">(</span><span class="n">shinfo</span><span class="o">-&gt;</span><span class="n">frag_list</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">skb_free_head</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">napi_safe</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nl">exit</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* When we clone an SKB we copy the reycling bit. The pp_recycle
</span></span></span><span class="line"><span class="cl"><span class="cm">     * bit is only set on the head though, so in order to avoid races
</span></span></span><span class="line"><span class="cl"><span class="cm">     * while trying to recycle fragments on __skb_frag_unref() we need
</span></span></span><span class="line"><span class="cl"><span class="cm">     * to make one SKB responsible for triggering the recycle path.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * So disable the recycling bit if an SKB is cloned and we have
</span></span></span><span class="line"><span class="cl"><span class="cm">     * additional references to the fragmented part of the SKB.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Eventually the last SKB will have the recycling bit set and it&#39;s
</span></span></span><span class="line"><span class="cl"><span class="cm">     * dataref set to 0, which will trigger the recycling
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">pp_recycle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">skb_free_head</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">napi_safe</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head_frag</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">skb_pp_recycle</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">napi_safe</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">skb_free_frag</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">skb_kfree_head</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="nf">skb_end_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">bool</span> <span class="nf">skb_pp_recycle</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">napi_safe</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_PAGE_POOL</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pp_recycle</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">napi_pp_put_page</span><span class="p">(</span><span class="nf">virt_to_page</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">napi_safe</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="nf">napi_pp_put_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">napi_safe</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">allow_direct</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">page_pool</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">page</span> <span class="o">=</span> <span class="nf">compound_head</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* page-&gt;pp_magic is OR&#39;ed with PP_SIGNATURE after the allocation
</span></span></span><span class="line"><span class="cl"><span class="cm">     * in order to preserve any existing bits, such as bit 0 for the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * head page of compound page and bit 1 for pfmemalloc page, so
</span></span></span><span class="line"><span class="cl"><span class="cm">     * mask those bits for freeing side when doing below checking,
</span></span></span><span class="line"><span class="cl"><span class="cm">     * and page_is_pfmemalloc() is checked in __page_pool_put_page()
</span></span></span><span class="line"><span class="cl"><span class="cm">     * to avoid recycling the pfmemalloc page.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">((</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">pp_magic</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3UL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PP_SIGNATURE</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">pp</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">pp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Allow direct recycle if we have reasons to believe that we are
</span></span></span><span class="line"><span class="cl"><span class="cm">     * in the same context as the consumer would run, so there&#39;s
</span></span></span><span class="line"><span class="cl"><span class="cm">     * no possible race.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * __page_pool_put_page() makes sure we&#39;re not in hardirq context
</span></span></span><span class="line"><span class="cl"><span class="cm">     * and interrupts are enabled prior to accessing the cache.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">napi_safe</span> <span class="o">||</span> <span class="nf">in_softirq</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span> <span class="o">=</span> <span class="nf">READ_ONCE</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">napi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">allow_direct</span> <span class="o">=</span> <span class="n">napi</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">READ_ONCE</span><span class="p">(</span><span class="n">napi</span><span class="o">-&gt;</span><span class="n">list_owner</span><span class="p">)</span> <span class="o">==</span> <span class="nf">smp_processor_id</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Driver set this to memory recycling info. Reset it on recycle.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This will *not* work for NIC using a split-page memory model.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The page will be returned to the pool here regardless of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &#39;flipped&#39; fragment being in use or not.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">page_pool_put_full_page</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">allow_direct</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">napi_pp_put_page</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中关键之处：</p>
<ol>
<li><code>skb-&gt;head_frag</code></li>
<li><code>skb-&gt;pp_recycle</code></li>
</ol>
<p>有没有办法遍历 tcp socket，并查看 <code>sk-&gt;sk_receive_queue</code> 里的 skb 呢？</p>
<h3 id="23-尝试-bpf-的-itertcp">2.3. 尝试 bpf 的 <code>iter/tcp</code></h3>
<p>让 AI 生成了 bpf 代码，调整一下，如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//go:build ignore
</span></span></span><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: GPL-2.0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cm">/* Copyright 2025 Leon Hwang */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;bpf_all.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nf">SEC</span><span class="p">(</span><span class="s">&#34;iter/tcp&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">iter_tcp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bpf_iter__tcp</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sock_common</span> <span class="o">*</span><span class="n">skc</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sk_common</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">tcp_sock</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">queue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">qlen</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cnt_pp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">tp</span> <span class="o">=</span> <span class="nf">bpf_skc_to_tcp_sock</span><span class="p">(</span><span class="n">skc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">sk</span>   <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="p">)</span><span class="n">tp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">qlen</span> <span class="o">=</span> <span class="nf">BPF_CORE_READ</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">qlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">skb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="nf">BPF_CORE_READ</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="o">&amp;&amp;</span> <span class="n">skb</span> <span class="o">!=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="n">queue</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cnt_pp</span> <span class="o">+=</span> <span class="nf">BPF_CORE_READ_BITFIELD_PROBED</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pp_recycle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">skb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="nf">BPF_CORE_READ</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">BPF_SEQ_PRINTF</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&#34;state=%d src=%pI4:%u dst=%pI4:%u</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">skc</span><span class="o">-&gt;</span><span class="n">skc_state</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="o">&amp;</span><span class="n">skc</span><span class="o">-&gt;</span><span class="n">skc_rcv_saddr</span><span class="p">,</span> <span class="n">skc</span><span class="o">-&gt;</span><span class="n">skc_num</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="o">&amp;</span><span class="n">skc</span><span class="o">-&gt;</span><span class="n">skc_daddr</span><span class="p">,</span> <span class="nf">bpf_ntohs</span><span class="p">(</span><span class="n">skc</span><span class="o">-&gt;</span><span class="n">skc_dport</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">BPF_SEQ_PRINTF</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&#34;  rx_queue: qlen=%d iterated=%d (pp_recycle=%d)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">qlen</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">cnt_pp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可是，跑起来后，什么都没有。</p>
<p>得另想办法。</p>
<h3 id="24-使用内核模块遍历-tcp-socket">2.4. 使用内核模块遍历 tcp socket</h3>
<p>使用内核模块来遍历指定 PID 的所有 tcp socket，肯定靠谱，而且能拿到所有需要的信息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/pid.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/sched.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/fs.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/file.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/fdtable.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;net/sock.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;net/inet_sock.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;net/tcp.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;net/tcp_states.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/ip.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/tcp.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/inet.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;net/ipv6.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;net/page_pool/helpers.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">pid_t</span> <span class="n">target_pid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">tcp_state_str</span><span class="p">(</span><span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">TCP_ESTABLISHED</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;ESTABLISHED&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">TCP_SYN_SENT</span><span class="p">:</span>    <span class="k">return</span> <span class="s">&#34;SYN_SENT&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">TCP_SYN_RECV</span><span class="p">:</span>    <span class="k">return</span> <span class="s">&#34;SYN_RECV&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">TCP_FIN_WAIT1</span><span class="p">:</span>   <span class="k">return</span> <span class="s">&#34;FIN_WAIT1&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">TCP_FIN_WAIT2</span><span class="p">:</span>   <span class="k">return</span> <span class="s">&#34;FIN_WAIT2&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">TCP_TIME_WAIT</span><span class="p">:</span>   <span class="k">return</span> <span class="s">&#34;TIME_WAIT&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">TCP_CLOSE</span><span class="p">:</span>       <span class="k">return</span> <span class="s">&#34;CLOSE&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">TCP_CLOSE_WAIT</span><span class="p">:</span>  <span class="k">return</span> <span class="s">&#34;CLOSE_WAIT&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">TCP_LAST_ACK</span><span class="p">:</span>    <span class="k">return</span> <span class="s">&#34;LAST_ACK&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">TCP_LISTEN</span><span class="p">:</span>      <span class="k">return</span> <span class="s">&#34;LISTEN&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">TCP_CLOSING</span><span class="p">:</span>     <span class="k">return</span> <span class="s">&#34;CLOSING&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">TCP_NEW_SYN_RECV</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;NEW_SYN_RECV&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="o">:</span>              <span class="k">return</span> <span class="s">&#34;UNKNOWN&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">log_pp_recycled_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ino</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">qlen</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">inet_sock</span> <span class="o">*</span><span class="n">inet</span> <span class="o">=</span> <span class="nf">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">tcp_sock</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="nf">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">skb_shared_info</span> <span class="o">*</span><span class="n">shinfo</span> <span class="o">=</span> <span class="nf">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">src_ip</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">dst_ip</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">u16</span> <span class="n">src_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dst_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_family</span> <span class="o">==</span> <span class="n">AF_INET</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">snprintf</span><span class="p">(</span><span class="n">src_ip</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">src_ip</span><span class="p">),</span> <span class="s">&#34;%pI4&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_saddr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">snprintf</span><span class="p">(</span><span class="n">dst_ip</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dst_ip</span><span class="p">),</span> <span class="s">&#34;%pI4&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_daddr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">src_port</span> <span class="o">=</span> <span class="nf">ntohs</span><span class="p">(</span><span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_sport</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">dst_port</span> <span class="o">=</span> <span class="nf">ntohs</span><span class="p">(</span><span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_dport</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if IS_ENABLED(CONFIG_IPV6)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_family</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">snprintf</span><span class="p">(</span><span class="n">src_ip</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">src_ip</span><span class="p">),</span> <span class="s">&#34;%pI6c&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_v6_rcv_saddr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">snprintf</span><span class="p">(</span><span class="n">dst_ip</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dst_ip</span><span class="p">),</span> <span class="s">&#34;%pI6c&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_v6_daddr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">src_port</span> <span class="o">=</span> <span class="nf">ntohs</span><span class="p">(</span><span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_sport</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">dst_port</span> <span class="o">=</span> <span class="nf">ntohs</span><span class="p">(</span><span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_dport</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;pid %d socket 0x%llx ino=%lu state=%u/%s shutdown=0x%x err=%d(soft=%d) linger2=%d dead=%u: receive_queue(qlen=%u): skb 0x%llx pp_recycle=%d tcp_flags=0x%02x cloned=%u head_frag=%u %s:%u-&gt;%s:%u len=%u data_len=%u nr_frags=%u</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">target_pid</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sk</span><span class="p">,</span> <span class="n">ino</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span><span class="p">,</span> <span class="nf">tcp_state_str</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err_soft</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">linger2</span><span class="p">,</span> <span class="nf">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">qlen</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">pp_recycle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nf">TCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tcp_flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cloned</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">head_frag</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">src_ip</span><span class="p">,</span> <span class="n">src_port</span><span class="p">,</span> <span class="n">dst_ip</span><span class="p">,</span> <span class="n">dst_port</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">,</span> <span class="n">shinfo</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Log linear buffer head page if present */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">head_page</span> <span class="o">=</span> <span class="nf">virt_to_head_page</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">dma_addr_t</span> <span class="n">head_dma</span> <span class="o">=</span> <span class="nf">page_pool_get_dma_addr</span><span class="p">(</span><span class="n">head_page</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;  pid %d head: page=0x%llx pfn=%lu data_off=%u headlen=%u dma=0x%llx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">target_pid</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">head_page</span><span class="p">,</span> <span class="nf">page_to_pfn</span><span class="p">(</span><span class="n">head_page</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">),</span> <span class="nf">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">head_dma</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">shinfo</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="kt">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">shinfo</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="nf">skb_frag_page</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">dma_addr_t</span> <span class="n">dma</span> <span class="o">=</span> <span class="nf">page_pool_get_dma_addr</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;  pid %d frag[%u]: page=0x%llx pfn=%lu off=%u size=%u dma=0x%llx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">target_pid</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">page</span><span class="p">,</span> <span class="nf">page_to_pfn</span><span class="p">(</span><span class="n">page</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nf">skb_frag_off</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span> <span class="nf">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">dma</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">inspect_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ino</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">qlen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">owned_before</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sk</span> <span class="o">||</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SOCK_STREAM</span> <span class="o">||</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_protocol</span> <span class="o">!=</span> <span class="n">IPPROTO_TCP</span> <span class="o">||</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_CLOSE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">owned_before</span> <span class="o">=</span> <span class="nf">sock_owned_by_user</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Log if we had to wait for lock */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">owned_before</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;pid %d socket %p ino=%lu: WAITED for lock (was owned=%d)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">target_pid</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">ino</span><span class="p">,</span> <span class="n">owned_before</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">qlen</span> <span class="o">=</span> <span class="nf">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Check if there&#39;s backlog that will be processed */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_backlog</span><span class="p">.</span><span class="n">tail</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;pid %d socket %p ino=%lu: HAS BACKLOG (tail=0x%llx)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">target_pid</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">ino</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_backlog</span><span class="p">.</span><span class="n">tail</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">skb_queue_walk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">log_pp_recycled_skb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">ino</span><span class="p">,</span> <span class="n">qlen</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">bool</span> <span class="nf">inspect_fd_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">files_struct</span> <span class="o">*</span><span class="n">files</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">fdtable</span> <span class="o">*</span><span class="n">fdt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">file</span> <span class="n">__rcu</span> <span class="o">**</span><span class="n">fdentry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ino</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">rcu_read_lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">fdt</span> <span class="o">=</span> <span class="nf">files_fdtable</span><span class="p">(</span><span class="n">files</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&gt;=</span> <span class="n">fdt</span><span class="o">-&gt;</span><span class="n">max_fds</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">rcu_read_unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">fdentry</span> <span class="o">=</span> <span class="n">fdt</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">+</span> <span class="nf">array_index_nospec</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fdt</span><span class="o">-&gt;</span><span class="n">max_fds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">file</span> <span class="o">=</span> <span class="nf">rcu_dereference_raw</span><span class="p">(</span><span class="o">*</span><span class="n">fdentry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span> <span class="o">||</span> <span class="o">!</span><span class="nf">get_file_rcu</span><span class="p">(</span><span class="n">file</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">rcu_read_unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="nf">files_fdtable</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fdt</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlikely</span><span class="p">(</span><span class="nf">rcu_dereference_raw</span><span class="p">(</span><span class="o">*</span><span class="n">fdentry</span><span class="p">)</span> <span class="o">!=</span> <span class="n">file</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fput</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">rcu_read_unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">rcu_read_unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">file_inode</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">ino</span> <span class="o">=</span> <span class="nf">file_inode</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">sock</span> <span class="o">=</span> <span class="nf">sock_from_file</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">inspect_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">ino</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fput</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">walk_task_sockets</span><span class="p">(</span><span class="k">struct</span> <span class="n">files_struct</span> <span class="o">*</span><span class="n">files</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">fd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nf">inspect_fd_entry</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span> <span class="n">fd</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">qinspect_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">pid</span> <span class="o">*</span><span class="n">pid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">files_struct</span> <span class="o">*</span><span class="n">files</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">pid</span> <span class="o">=</span> <span class="nf">find_get_pid</span><span class="p">(</span><span class="n">target_pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">task</span> <span class="o">=</span> <span class="nf">get_pid_task</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">PIDTYPE_PID</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">put_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">task_lock</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">files</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">files</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">files</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">task_unlock</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">files</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out_put_task</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">walk_task_sockets</span><span class="p">(</span><span class="n">files</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">files</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">out_put_task</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nf">put_task_struct</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">qinspect_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">module_param</span><span class="p">(</span><span class="n">target_pid</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">module_init</span><span class="p">(</span><span class="n">qinspect_init</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">module_exit</span><span class="p">(</span><span class="n">qinspect_exit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">MODULE_LICENSE</span><span class="p">(</span><span class="s">&#34;GPL&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&#34;Leon Hwang &lt;leon.hwang@linux.dev&gt;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&#34;TCP Socket sk_receive_queue Inspection Module&#34;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>需要 Makefile:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="nv">KDIR</span> <span class="o">?=</span> /lib/modules/<span class="k">$(</span>shell uname -r<span class="k">)</span>/build
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">KMOD_NAME</span> <span class="o">:=</span> tcp_rxq
</span></span><span class="line"><span class="cl"><span class="nv">KMOD</span> <span class="o">:=</span> <span class="k">$(</span>KMOD_NAME<span class="k">)</span>.ko
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">obj-m</span> <span class="o">:=</span> <span class="k">$(</span>KMOD_NAME<span class="k">)</span>.o
</span></span><span class="line"><span class="cl"><span class="nv">$(KMOD_NAME)-objs</span> <span class="o">:=</span> <span class="k">$(</span>KMOD_NAME<span class="k">)</span>.kmod.o
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">all</span> <span class="n">clean</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">all</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">$(</span>MAKE<span class="k">)</span> -C <span class="k">$(</span>KDIR<span class="k">)</span> <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>CURDIR<span class="k">)</span> modules
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">clean</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">$(</span>MAKE<span class="k">)</span> -C <span class="k">$(</span>KDIR<span class="k">)</span> <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>CURDIR<span class="k">)</span> clean
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">run</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> -z <span class="k">$(</span>PID<span class="k">)</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="nb">exit</span> 1<span class="p">;</span> <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    insmod <span class="k">$(</span>KMOD<span class="k">)</span> <span class="nv">target_pid</span><span class="o">=</span><span class="k">$(</span>PID<span class="k">)</span>
</span></span><span class="line"><span class="cl">    rmmod <span class="k">$(</span>KMOD_NAME<span class="k">)</span>
</span></span><span class="line"><span class="cl">    dmesg <span class="p">|</span> grep <span class="k">$(</span>PID<span class="k">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>用法：<code>make run PID=$(pidof xxx-agent)</code>。</p>
<p>跑起来后，可以看到：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[102694.540568] pid 286275 socket 0xff110002e0c53600 ino=4741242 state=7/CLOSE shutdown=0x3 err=32(soft=0) linger2=0 dead=0: receive_queue(qlen=1): skb 0xff110002b6aa6100 pp_recycle=1 tcp_flags=0x11 cloned=0 head_frag=1 10.x.x.x:43542-&gt;10.y.y.y:9093 len=0 data_len=0 nr_frags=0
</span></span><span class="line"><span class="cl">[102694.540576]   pid 286275 head: page=0xffd400000f7bd040 pfn=4058945 data_off=118 headlen=0 dma=0x3def41000
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中关键信息：</p>
<ol>
<li>有不少 socket 的状态是 <code>TCP_CLOSE</code>。</li>
<li><code>sk-&gt;sk_receive_queue</code> 缓存着一个 <strong>FINACK</strong> skb（<code>tcp_flags=0x11</code>）。</li>
<li>目的端口是 <strong>9093</strong>。</li>
<li><code>pp_recycle=1</code>。</li>
<li>该 skb 引用着一个 page。</li>
</ol>
<p>到目前为止，dmesg 里打印 log 的行为便解释得通了。</p>
<p>可是，事情并未结束呀：</p>
<ol start="0">
<li>那些 socket 的状态为什么会变成 <code>TCP_CLOSE</code> 的？</li>
<li>根因是？</li>
<li>从根本上解决掉问题。</li>
<li>有哪些地方可以改进呢？</li>
</ol>
<h3 id="25-socket-变成-tcp_close-的原因">2.5. socket 变成 <code>TCP_CLOSE</code> 的原因</h3>
<p>继续祭出 bpfsnoop:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># bpfsnoop \</span>
</span></span><span class="line"><span class="cl">        -k sk_stream_wait_close <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        -k <span class="s1">&#39;(s)tcp_reset&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        -k <span class="s1">&#39;(s)tcp_done&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        -k <span class="s1">&#39;(s)tcp_done_with_error&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        -k <span class="s1">&#39;(b)__tcp_close&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                --output-arg <span class="s1">&#39;sk-&gt;sk_receive_queue.qlen&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                --output-arg <span class="s1">&#39;&amp;sk-&gt;sk_receive_queue&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                --output-arg <span class="s1">&#39;sk-&gt;sk_receive_queue.next&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                --output-arg <span class="s1">&#39;sk-&gt;sk_receive_queue.prev&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                --output-arg <span class="s1">&#39;sk-&gt;sk_receive_queue.next-&gt;pp_recycle&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                --output-arg <span class="s1">&#39;ip42(&amp;sk-&gt;__sk_common.skc_daddr)&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                --output-arg <span class="s1">&#39;port(&amp;sk-&gt;__sk_common.skc_dport)&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                --output-arg <span class="s1">&#39;sk-&gt;__sk_common.skc_num&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        -o tcp_close.bpfsnoop.4.log
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">← tcp_done_with_error <span class="nv">args</span><span class="o">=((</span>struct sock *<span class="o">)</span><span class="nv">sk</span><span class="o">=</span>0xff1100011a2f0900, <span class="o">(</span>int<span class="o">)</span><span class="nv">err</span><span class="o">=</span>32<span class="o">)</span> <span class="nv">retval</span><span class="o">=(</span>void<span class="o">)</span> <span class="nv">cpu</span><span class="o">=</span><span class="m">45</span> <span class="nv">process</span><span class="o">=(</span>0:swapper/45<span class="o">)</span> <span class="nv">timestamp</span><span class="o">=</span>15:06:41.253928962
</span></span><span class="line"><span class="cl">Arg attrs: <span class="o">(</span>__u32<span class="o">)</span><span class="s1">&#39;sk-&gt;sk_receive_queue.qlen&#39;</span><span class="o">=</span>0x1/1, <span class="o">(</span>struct sk_buff_head *<span class="o">)</span><span class="s1">&#39;&amp;sk-&gt;sk_receive_queue&#39;</span><span class="o">=</span>0xff1100011a2f09d8, <span class="o">(</span>struct sk_buff *<span class="o">)</span><span class="s1">&#39;sk-&gt;sk_receive_queue.next&#39;</span><span class="o">=</span>0xff1100012619a100, <span class="o">(</span>struct sk_buff *<span class="o">)</span><span class="s1">&#39;sk-&gt;sk_receive_queue.prev&#39;</span><span class="o">=</span>0xff1100012619a100, <span class="o">(</span>__u8<span class="o">)</span><span class="s1">&#39;sk-&gt;sk_receive_queue.next-&gt;pp_recycle&#39;</span><span class="o">=</span>0x1, <span class="o">(</span>unsigned int *<span class="o">)</span><span class="s1">&#39;ip42(&amp;sk-&gt;__sk_common.skc_daddr)&#39;</span><span class="o">=[</span>10.x.x.x,10.y.y.y<span class="o">]</span>, <span class="o">(</span>short unsigned int *<span class="o">)</span><span class="s1">&#39;port(&amp;sk-&gt;__sk_common.skc_dport)&#39;</span><span class="o">=</span>9092, <span class="o">(</span>__u16<span class="o">)</span><span class="s1">&#39;sk-&gt;__sk_common.skc_num&#39;</span><span class="o">=</span>0x0/0
</span></span><span class="line"><span class="cl">Func stack:
</span></span><span class="line"><span class="cl">  tcp_done_with_error+0x5                               <span class="p">;</span> net/ipv4/tcp_input.c:4441
</span></span><span class="line"><span class="cl">  bpf_trampoline_6442479037+0x39
</span></span><span class="line"><span class="cl">  tcp_reset+0x5                                         <span class="p">;</span> net/ipv4/tcp_input.c:4456
</span></span><span class="line"><span class="cl">  tcp_rcv_state_process+0x20e                           <span class="p">;</span> net/ipv4/tcp_input.c:6696
</span></span><span class="line"><span class="cl">  tcp_v4_do_rcv+0xd3                                    <span class="p">;</span> net/ipv4/tcp_ipv4.c:1757
</span></span><span class="line"><span class="cl">  tcp_v4_rcv+0xbe2                                      <span class="p">;</span> net/ipv4/tcp_ipv4.c:2166
</span></span><span class="line"><span class="cl">  ip_protocol_deliver_rcu+0x3c                          <span class="p">;</span> net/ipv4/ip_input.c:205
</span></span><span class="line"><span class="cl">  ip_local_deliver_finish+0x72                          <span class="p">;</span> net/ipv4/ip_input.c:237
</span></span><span class="line"><span class="cl">  ip_local_deliver+0x6c                                 <span class="p">;</span> net/ipv4/ip_input.c:257
</span></span><span class="line"><span class="cl">  ip_sublist_rcv_finish+0x77                            <span class="p">;</span> include/net/dst.h:477
</span></span><span class="line"><span class="cl">  ip_sublist_rcv+0x17c                                  <span class="p">;</span> net/ipv4/ip_input.c:640
</span></span><span class="line"><span class="cl">  ip_list_rcv+0x102                                     <span class="p">;</span> net/ipv4/ip_input.c:675
</span></span><span class="line"><span class="cl">  __netif_receive_skb_list_core+0x22d                   <span class="p">;</span> net/core/dev.c:5639
</span></span><span class="line"><span class="cl">  netif_receive_skb_list_internal+0x19e                 <span class="p">;</span> net/core/dev.c:5741
</span></span><span class="line"><span class="cl">  napi_complete_done+0x74                               <span class="p">;</span> include/net/gro.h:448
</span></span><span class="line"><span class="cl">  mlx5e_napi_poll+0x173
</span></span><span class="line"><span class="cl">  __napi_poll+0x33                                      <span class="p">;</span> net/core/dev.c:6600
</span></span><span class="line"><span class="cl">  net_rx_action+0x18a                                   <span class="p">;</span> net/core/dev.c:6669
</span></span><span class="line"><span class="cl">  handle_softirqs+0xe8                                  <span class="p">;</span> arch/x86/include/asm/jump_label.h:27
</span></span><span class="line"><span class="cl">  __irq_exit_rcu+0x77                                   <span class="p">;</span> kernel/softirq.c:612
</span></span><span class="line"><span class="cl">  irq_exit_rcu+0xe                                      <span class="p">;</span> kernel/softirq.c:676
</span></span><span class="line"><span class="cl">  common_interrupt+0xa4
</span></span><span class="line"><span class="cl">  asm_common_interrupt+0x27                             <span class="p">;</span> arch/x86/include/asm/idtentry.h:678
</span></span><span class="line"><span class="cl">  cpuidle_enter_state+0xda                              <span class="p">;</span> drivers/cpuidle/cpuidle.c:291
</span></span><span class="line"><span class="cl">  cpuidle_enter+0x2e
</span></span><span class="line"><span class="cl">  call_cpuidle+0x23                                     <span class="p">;</span> kernel/sched/idle.c:135
</span></span><span class="line"><span class="cl">  cpuidle_idle_call+0x11d                               <span class="p">;</span> kernel/sched/idle.c:219
</span></span><span class="line"><span class="cl">  do_idle+0x82                                          <span class="p">;</span> kernel/sched/idle.c:284
</span></span><span class="line"><span class="cl">  cpu_startup_entry+0x2a                                <span class="p">;</span> kernel/sched/idle.c:379
</span></span><span class="line"><span class="cl">  start_secondary+0x129                                 <span class="p">;</span> arch/x86/kernel/smpboot.c:211
</span></span><span class="line"><span class="cl">  secondary_startup_64_no_verify+0x18f                  <span class="p">;</span> arch/x86/kernel/head_64.S:449
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中 <code>err=32</code> 就是 <code>err = EPIPE</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// net/ipv4/tcp_input.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">tcp_done_with_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* This barrier is coupled with smp_rmb() in tcp_poll() */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">WRITE_ONCE</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">smp_wmb</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">tcp_write_queue_purge</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">tcp_done</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sk_error_report</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tcp_done_with_error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* When we get a reset we do this. */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">tcp_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">trace_tcp_receive_reset</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* mptcp can&#39;t tell us to ignore reset pkts,
</span></span></span><span class="line"><span class="cl"><span class="cm">     * so just ignore the return value of mptcp_incoming_options().
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">sk_is_mptcp</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nf">mptcp_incoming_options</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* We want the right error as BSD sees it (and indeed as we do). */</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">TCP_SYN_SENT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="n">ECONNREFUSED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">TCP_CLOSE_WAIT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="n">EPIPE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">TCP_CLOSE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="n">ECONNRESET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">tcp_done_with_error</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>所以：</p>
<ol>
<li>socket 先收到 FIN 包，状态变为 <code>TCP_CLOSE_WAIT</code>。</li>
<li>socket 再收到 FINACK 包，缓存到 <code>sk-&gt;sk_receive_queue</code>。</li>
<li>socket 最后收到 RST 包，状态变为 <code>TCP_CLOSE</code>。</li>
</ol>
<h2 id="3-sarama-存在-tcp-连接泄漏问题">3. sarama 存在 tcp 连接泄漏问题</h2>
<p>在跟同事讨论后，确认：<strong>9093</strong> 是 Kafka 服务端的端口，而且用来连接 Kafka 的库是 sarama。</p>
<p>查看一下 sarama 的 issue 列表，已经有人提了相关问题：</p>
<ul>
<li><a href="https://github.com/IBM/sarama/issues/3143">Client SeekBroker Connection Leak</a></li>
</ul>
<p>但是，该问题有待进一步排查。</p>
<h3 id="31-给-sarama-加更多-log">3.1. 给 sarama 加更多 log</h3>
<p>直接修改 sarama 代码：</p>
<ol>
<li>在 broker 里涉及 tcp 连接的地方加 log。</li>
<li>在 client 里涉及 broker 的地方加 log。</li>
<li>在用户态进程里开启 sarama 的 logger。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gh">diff --git a/broker.go b/broker.go
</span></span></span><span class="line"><span class="cl"><span class="gh">index d0d5b87..9cc4ca2 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/broker.go
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/broker.go
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -155,6 +155,36 @@ func NewBroker(addr string) *Broker {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>    return &amp;Broker{id: -1, addr: addr}
</span></span><span class="line"><span class="cl"> }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gi">+func (b *Broker) connInfo(conn net.Conn) string {
</span></span></span><span class="line"><span class="cl"><span class="gi">+   if conn == nil {
</span></span></span><span class="line"><span class="cl"><span class="gi">+       return &#34;not connected&#34;
</span></span></span><span class="line"><span class="cl"><span class="gi">+   }
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi">+   laddr, raddr := conn.LocalAddr(), conn.RemoteAddr()
</span></span></span><span class="line"><span class="cl"><span class="gi">+   return fmt.Sprintf(&#34;laddr=%s raddr=%s&#34;, laddr.String(), raddr.String())
</span></span></span><span class="line"><span class="cl"><span class="gi">+}
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi">+func (b *Broker) debugInfo() string {
</span></span></span><span class="line"><span class="cl"><span class="gi">+   var sb strings.Builder
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi">+   fmt.Fprintf(&amp;sb, &#34;id=0x%x addr=%s %s&#34;, b.id, b.addr, b.connInfo(b.conn))
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi">+   return sb.String()
</span></span></span><span class="line"><span class="cl"><span class="gi">+}
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>
</span></span><span class="line"><span class="cl"> // Open tries to connect to the Broker if it is not already connected or connecting, but does not block
</span></span><span class="line"><span class="cl"> // waiting for the connection to complete. This means that any subsequent operations on the broker will
</span></span><span class="line"><span class="cl"> // block waiting for the connection to succeed or fail. To get the effect of a fully synchronous Open call,
</span></span><span class="line"><span class="cl"><span class="gu">@@ -202,16 +232,26 @@ func (b *Broker) Open(conf *Config) error {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>        }()
</span></span><span class="line"><span class="cl">        dialer := conf.getDialer()
</span></span><span class="line"><span class="cl">        b.conn, b.connErr = dialer.Dial(&#34;tcp&#34;, b.addr)
</span></span><span class="line"><span class="cl"><span class="gi">+       Logger.Printf(&#34;[DBG] [BROKER] connecting conn[%s] err[%v]\n&#34;, b.connInfo(b.conn), b.connErr)
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>        if b.connErr != nil {
</span></span><span class="line"><span class="cl">            Logger.Printf(&#34;Failed to connect to broker %s: %s\n&#34;, b.addr, b.connErr)
</span></span><span class="line"><span class="cl">            b.conn = nil
</span></span><span class="line"><span class="cl">            atomic.StoreInt32(&amp;b.opened, 0)
</span></span><span class="line"><span class="cl">            return
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">        if conf.Net.TLS.Enable {
</span></span><span class="line"><span class="cl">            b.conn = tls.Client(b.conn, validServerNameTLS(b.addr, conf.Net.TLS.Config))
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gi">+       Logger.Printf(&#34;[DBG] [BROKER] connected %s\n&#34;, b.debugInfo())
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>        b.conn = newBufConn(b.conn)
</span></span><span class="line"><span class="cl">        b.conf = conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gu">@@ -241,7 +281,7 @@ func (b *Broker) Open(conf *Config) error {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>            b.connErr = b.authenticateViaSASLv0()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            if b.connErr != nil {
</span></span><span class="line"><span class="cl"><span class="gd">-               err = b.conn.Close()
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+               err = b.closeConn()
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>                if err == nil {
</span></span><span class="line"><span class="cl">                    DebugLogger.Printf(&#34;Closed connection to broker %s\n&#34;, b.addr)
</span></span><span class="line"><span class="cl">                } else {
</span></span><span class="line"><span class="cl"><span class="gu">@@ -262,7 +302,7 @@ func (b *Broker) Open(conf *Config) error {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>            if b.connErr != nil {
</span></span><span class="line"><span class="cl">                close(b.responses)
</span></span><span class="line"><span class="cl">                &lt;-b.done
</span></span><span class="line"><span class="cl"><span class="gd">-               err = b.conn.Close()
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+               err = b.closeConn()
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>                if err == nil {
</span></span><span class="line"><span class="cl">                    DebugLogger.Printf(&#34;Closed connection to broker %s\n&#34;, b.addr)
</span></span><span class="line"><span class="cl">                } else {
</span></span><span class="line"><span class="cl"><span class="gu">@@ -278,6 +318,8 @@ func (b *Broker) Open(conf *Config) error {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>        } else {
</span></span><span class="line"><span class="cl">            DebugLogger.Printf(&#34;Connected to broker at %s (unregistered)\n&#34;, b.addr)
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi">+       Logger.Printf(&#34;[DBG] [BROKER] opened %s\n&#34;, b.debugInfo())
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>    })
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    return nil
</span></span><span class="line"><span class="cl"><span class="gu">@@ -290,6 +332,13 @@ func (b *Broker) ResponseSize() int {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>    return len(b.responses)
</span></span><span class="line"><span class="cl"> }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gi">+func (b *Broker) closeConn() error {
</span></span></span><span class="line"><span class="cl"><span class="gi">+   dbgInfo := b.debugInfo()
</span></span></span><span class="line"><span class="cl"><span class="gi">+   err := b.conn.Close()
</span></span></span><span class="line"><span class="cl"><span class="gi">+   Logger.Printf(&#34;[DBG] [BROKER] closed %s (err=%v)\n&#34;, dbgInfo, err)
</span></span></span><span class="line"><span class="cl"><span class="gi">+   return err
</span></span></span><span class="line"><span class="cl"><span class="gi">+}
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi"></span> // Connected returns true if the broker is connected and false otherwise. If the broker is not
</span></span><span class="line"><span class="cl"> // connected but it had tried to connect, the error from that connection attempt is also returned.
</span></span><span class="line"><span class="cl"> func (b *Broker) Connected() (bool, error) {
</span></span><span class="line"><span class="cl"><span class="gu">@@ -329,7 +378,7 @@ func (b *Broker) Close() error {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>    close(b.responses)
</span></span><span class="line"><span class="cl">    &lt;-b.done
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gd">-   err := b.conn.Close()
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+   err := b.closeConn()
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>
</span></span><span class="line"><span class="cl">    b.conn = nil
</span></span><span class="line"><span class="cl">    b.connErr = nil
</span></span><span class="line"><span class="cl"><span class="gh">diff --git a/client.go b/client.go
</span></span></span><span class="line"><span class="cl"><span class="gh">index 2decba7..20644b6 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/client.go
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/client.go
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -3,6 +3,8 @@ package sarama
</span></span></span><span class="line"><span class="cl"><span class="gu"></span> import (
</span></span><span class="line"><span class="cl">    &#34;context&#34;
</span></span><span class="line"><span class="cl">    &#34;errors&#34;
</span></span><span class="line"><span class="cl"><span class="gi">+   &#34;fmt&#34;
</span></span></span><span class="line"><span class="cl"><span class="gi">+   &#34;io&#34;
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>    &#34;math&#34;
</span></span><span class="line"><span class="cl">    &#34;math/rand&#34;
</span></span><span class="line"><span class="cl">    &#34;net&#34;
</span></span><span class="line"><span class="cl"><span class="gu">@@ -236,6 +238,43 @@ func (client *client) Config() *Config {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>    return client.conf
</span></span><span class="line"><span class="cl"> }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gi">+func (client *client) printAllBrokersInfo(sb *strings.Builder) {
</span></span></span><span class="line"><span class="cl"><span class="gi">+   sb.WriteString(&#34;[DBG] [CLIENT] ALL brokers:\n&#34;)
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi">+   sb.WriteString(&#34;[DBG] [CLIENT] Seed brokers:\n&#34;)
</span></span></span><span class="line"><span class="cl"><span class="gi">+   for i, broker := range client.seedBrokers {
</span></span></span><span class="line"><span class="cl"><span class="gi">+       if broker == nil {
</span></span></span><span class="line"><span class="cl"><span class="gi">+           fmt.Fprintf(sb, &#34;  [DBG] [CLIENT] seed broker #%d: &lt;nil&gt;\n&#34;, i)
</span></span></span><span class="line"><span class="cl"><span class="gi">+       } else {
</span></span></span><span class="line"><span class="cl"><span class="gi">+           fmt.Fprintf(sb, &#34;  [DBG] [CLIENT] seed broker #%d: %s\n&#34;, i, broker.debugInfo())
</span></span></span><span class="line"><span class="cl"><span class="gi">+       }
</span></span></span><span class="line"><span class="cl"><span class="gi">+   }
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi">+   sb.WriteString(&#34;[DBG] [CLIENT] Dead seed brokers:\n&#34;)
</span></span></span><span class="line"><span class="cl"><span class="gi">+   for i, broker := range client.deadSeeds {
</span></span></span><span class="line"><span class="cl"><span class="gi">+       if broker == nil {
</span></span></span><span class="line"><span class="cl"><span class="gi">+           fmt.Fprintf(sb, &#34;  [DBG] [CLIENT] dead seed broker #%d: &lt;nil&gt;\n&#34;, i)
</span></span></span><span class="line"><span class="cl"><span class="gi">+       } else {
</span></span></span><span class="line"><span class="cl"><span class="gi">+           fmt.Fprintf(sb, &#34;  [DBG] [CLIENT] dead seed broker #%d: %s\n&#34;, i, broker.debugInfo())
</span></span></span><span class="line"><span class="cl"><span class="gi">+       }
</span></span></span><span class="line"><span class="cl"><span class="gi">+   }
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi">+   sb.WriteString(&#34;[DBG] [CLIENT] Registered brokers:\n&#34;)
</span></span></span><span class="line"><span class="cl"><span class="gi">+   client.printBrokersInfo(sb)
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi">+   Logger.Printf(sb.String())
</span></span></span><span class="line"><span class="cl"><span class="gi">+}
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi">+func (client *client) printBrokersInfo(w io.Writer) {
</span></span></span><span class="line"><span class="cl"><span class="gi">+   for id, broker := range client.brokers {
</span></span></span><span class="line"><span class="cl"><span class="gi">+       if broker == nil {
</span></span></span><span class="line"><span class="cl"><span class="gi">+           fmt.Fprintf(w, &#34;  [DBG] [CLIENT] broker id#%d: &lt;nil&gt;\n&#34;, id)
</span></span></span><span class="line"><span class="cl"><span class="gi">+       } else {
</span></span></span><span class="line"><span class="cl"><span class="gi">+           fmt.Fprintf(w, &#34;  [DBG] [CLIENT] broker id#%d: %s\n&#34;, id, broker.debugInfo())
</span></span></span><span class="line"><span class="cl"><span class="gi">+       }
</span></span></span><span class="line"><span class="cl"><span class="gi">+   }
</span></span></span><span class="line"><span class="cl"><span class="gi">+}
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi"></span> func (client *client) Brokers() []*Broker {
</span></span><span class="line"><span class="cl">    client.lock.RLock()
</span></span><span class="line"><span class="cl">    defer client.lock.RUnlock()
</span></span><span class="line"><span class="cl"><span class="gu">@@ -243,6 +282,11 @@ func (client *client) Brokers() []*Broker {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>    for _, broker := range client.brokers {
</span></span><span class="line"><span class="cl">        brokers = append(brokers, broker)
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi">+   var sb strings.Builder
</span></span></span><span class="line"><span class="cl"><span class="gi">+   sb.WriteString(&#34;[DBG] [CLIENT] copied current brokers:\n&#34;)
</span></span></span><span class="line"><span class="cl"><span class="gi">+   client.printBrokersInfo(&amp;sb)
</span></span></span><span class="line"><span class="cl"><span class="gi">+   Logger.Printf(sb.String())
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>    return brokers
</span></span><span class="line"><span class="cl"> }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gu">@@ -308,6 +352,15 @@ func (client *client) Close() error {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>    defer client.lock.Unlock()
</span></span><span class="line"><span class="cl">    DebugLogger.Println(&#34;Closing Client&#34;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gi">+   var sb strings.Builder
</span></span></span><span class="line"><span class="cl"><span class="gi">+   sb.WriteString(&#34;[DBG] [CLIENT] Closing brokers:\n&#34;)
</span></span></span><span class="line"><span class="cl"><span class="gi">+   client.printAllBrokersInfo(&amp;sb)
</span></span></span><span class="line"><span class="cl"><span class="gi">+   defer func() {
</span></span></span><span class="line"><span class="cl"><span class="gi">+       sb.WriteString(&#34;[DBG] [CLIENT] After closing brokers:\n&#34;)
</span></span></span><span class="line"><span class="cl"><span class="gi">+       client.printAllBrokersInfo(&amp;sb)
</span></span></span><span class="line"><span class="cl"><span class="gi">+       Logger.Printf(sb.String())
</span></span></span><span class="line"><span class="cl"><span class="gi">+   }()
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>    for _, broker := range client.brokers {
</span></span><span class="line"><span class="cl">        safeAsyncClose(broker)
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl"><span class="gu">@@ -518,6 +571,15 @@ func (client *client) RefreshBrokers(addrs []string) error {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>    client.lock.Lock()
</span></span><span class="line"><span class="cl">    defer client.lock.Unlock()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gi">+   var sb strings.Builder
</span></span></span><span class="line"><span class="cl"><span class="gi">+   sb.WriteString(&#34;[DBG] [CLIENT] Refreshing brokers, closing existing brokers:\n&#34;)
</span></span></span><span class="line"><span class="cl"><span class="gi">+   client.printAllBrokersInfo(&amp;sb)
</span></span></span><span class="line"><span class="cl"><span class="gi">+   defer func() {
</span></span></span><span class="line"><span class="cl"><span class="gi">+       sb.WriteString(&#34;[DBG] [CLIENT] After refreshing brokers:\n&#34;)
</span></span></span><span class="line"><span class="cl"><span class="gi">+       client.printAllBrokersInfo(&amp;sb)
</span></span></span><span class="line"><span class="cl"><span class="gi">+       Logger.Printf(sb.String())
</span></span></span><span class="line"><span class="cl"><span class="gi">+   }()
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>    for _, broker := range client.brokers {
</span></span><span class="line"><span class="cl">        safeAsyncClose(broker)
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl"><span class="gu">@@ -608,6 +670,7 @@ func (client *client) deregisterController() {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>    if controller, ok := client.brokers[client.controllerID]; ok {
</span></span><span class="line"><span class="cl">        _ = controller.Close()
</span></span><span class="line"><span class="cl">        delete(client.brokers, client.controllerID)
</span></span><span class="line"><span class="cl"><span class="gi">+       Logger.Printf(&#34;[DBG] [CLIENT] deregistered controller broker #%d at %s&#34;, controller.ID(), controller.debugInfo())
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>    }
</span></span><span class="line"><span class="cl"> }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gu">@@ -723,6 +786,18 @@ func (client *client) randomizeSeedBrokers(addrs []string) {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span> func (client *client) updateBroker(brokers []*Broker) {
</span></span><span class="line"><span class="cl">    currentBroker := make(map[int32]*Broker, len(brokers))
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gi">+   var sb strings.Builder
</span></span></span><span class="line"><span class="cl"><span class="gi">+   sb.WriteString(&#34;[DBG] [CLIENT] Updating brokers with the following list:\n&#34;)
</span></span></span><span class="line"><span class="cl"><span class="gi">+   for _, broker := range brokers {
</span></span></span><span class="line"><span class="cl"><span class="gi">+       sb.WriteString(fmt.Sprintf(&#34;  [DBG] [CLIENT] broker to update: %s\n&#34;, broker.debugInfo()))
</span></span></span><span class="line"><span class="cl"><span class="gi">+   }
</span></span></span><span class="line"><span class="cl"><span class="gi">+   client.printAllBrokersInfo(&amp;sb)
</span></span></span><span class="line"><span class="cl"><span class="gi">+   defer func() {
</span></span></span><span class="line"><span class="cl"><span class="gi">+       sb.WriteString(&#34;[DBG] [CLIENT] After updating brokers:\n&#34;)
</span></span></span><span class="line"><span class="cl"><span class="gi">+       client.printAllBrokersInfo(&amp;sb)
</span></span></span><span class="line"><span class="cl"><span class="gi">+       Logger.Printf(sb.String())
</span></span></span><span class="line"><span class="cl"><span class="gi">+   }()
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>    for _, broker := range brokers {
</span></span><span class="line"><span class="cl">        currentBroker[broker.ID()] = broker
</span></span><span class="line"><span class="cl">        if client.brokers[broker.ID()] == nil { // add new broker
</span></span><span class="line"><span class="cl"><span class="gu">@@ -753,6 +828,16 @@ func (client *client) registerBroker(broker *Broker) {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>        return
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gi">+   var sb strings.Builder
</span></span></span><span class="line"><span class="cl"><span class="gi">+   sb.WriteString(&#34;[DBG] [CLIENT] Registering broker:\n&#34;)
</span></span></span><span class="line"><span class="cl"><span class="gi">+   sb.WriteString(fmt.Sprintf(&#34;  [DBG] [CLIENT] broker to register: %s\n&#34;, broker.debugInfo()))
</span></span></span><span class="line"><span class="cl"><span class="gi">+   client.printAllBrokersInfo(&amp;sb)
</span></span></span><span class="line"><span class="cl"><span class="gi">+   defer func() {
</span></span></span><span class="line"><span class="cl"><span class="gi">+       sb.WriteString(&#34;[DBG] [CLIENT] After registering broker, current brokers:\n&#34;)
</span></span></span><span class="line"><span class="cl"><span class="gi">+       client.printAllBrokersInfo(&amp;sb)
</span></span></span><span class="line"><span class="cl"><span class="gi">+       Logger.Printf(sb.String())
</span></span></span><span class="line"><span class="cl"><span class="gi">+   }()
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>    if client.brokers[broker.ID()] == nil {
</span></span><span class="line"><span class="cl">        client.brokers[broker.ID()] = broker
</span></span><span class="line"><span class="cl">        DebugLogger.Printf(&#34;client/brokers registered new broker #%d at %s&#34;, broker.ID(), broker.Addr())
</span></span><span class="line"><span class="cl"><span class="gu">@@ -769,6 +854,16 @@ func (client *client) deregisterBroker(broker *Broker) {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>    client.lock.Lock()
</span></span><span class="line"><span class="cl">    defer client.lock.Unlock()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gi">+   var sb strings.Builder
</span></span></span><span class="line"><span class="cl"><span class="gi">+   sb.WriteString(&#34;[DBG] [CLIENT] Deregistering broker:\n&#34;)
</span></span></span><span class="line"><span class="cl"><span class="gi">+   sb.WriteString(fmt.Sprintf(&#34;  [DBG] [CLIENT] broker to deregister: %s\n&#34;, broker.debugInfo()))
</span></span></span><span class="line"><span class="cl"><span class="gi">+   client.printAllBrokersInfo(&amp;sb)
</span></span></span><span class="line"><span class="cl"><span class="gi">+   defer func() {
</span></span></span><span class="line"><span class="cl"><span class="gi">+       sb.WriteString(&#34;[DBG] [CLIENT] After deregistering broker, current brokers:\n&#34;)
</span></span></span><span class="line"><span class="cl"><span class="gi">+       client.printAllBrokersInfo(&amp;sb)
</span></span></span><span class="line"><span class="cl"><span class="gi">+       Logger.Printf(sb.String())
</span></span></span><span class="line"><span class="cl"><span class="gi">+   }()
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>    _, ok := client.brokers[broker.ID()]
</span></span><span class="line"><span class="cl">    if ok {
</span></span><span class="line"><span class="cl">        Logger.Printf(&#34;client/brokers deregistered broker #%d at %s&#34;, broker.ID(), broker.Addr())
</span></span><span class="line"><span class="cl"><span class="gu">@@ -788,6 +883,11 @@ func (client *client) resurrectDeadBrokers() {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>    Logger.Printf(&#34;client/brokers resurrecting %d dead seed brokers&#34;, len(client.deadSeeds))
</span></span><span class="line"><span class="cl">    client.seedBrokers = append(client.seedBrokers, client.deadSeeds...)
</span></span><span class="line"><span class="cl">    client.deadSeeds = nil
</span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi">+   var sb strings.Builder
</span></span></span><span class="line"><span class="cl"><span class="gi">+   sb.WriteString(&#34;[DBG] [CLIENT] After resurrecting dead seed brokers, current brokers:\n&#34;)
</span></span></span><span class="line"><span class="cl"><span class="gi">+   client.printAllBrokersInfo(&amp;sb)
</span></span></span><span class="line"><span class="cl"><span class="gi">+   Logger.Printf(sb.String())
</span></span></span><span class="line"><span class="cl"><span class="gi"></span> }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> // LeastLoadedBroker returns the broker with the least pending requests.
</span></span><span class="line"><span class="cl"><span class="gu">@@ -796,6 +896,15 @@ func (client *client) LeastLoadedBroker() *Broker {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>    client.lock.RLock()
</span></span><span class="line"><span class="cl">    defer client.lock.RUnlock()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gi">+   var sb strings.Builder
</span></span></span><span class="line"><span class="cl"><span class="gi">+   sb.WriteString(&#34;[DBG] [CLIENT] Checking least loaded broker among current brokers:\n&#34;)
</span></span></span><span class="line"><span class="cl"><span class="gi">+   client.printBrokersInfo(&amp;sb)
</span></span></span><span class="line"><span class="cl"><span class="gi">+   defer func() {
</span></span></span><span class="line"><span class="cl"><span class="gi">+       sb.WriteString(&#34;[DBG] [CLIENT] Finished checking least loaded broker, current brokers\n&#34;)
</span></span></span><span class="line"><span class="cl"><span class="gi">+       client.printBrokersInfo(&amp;sb)
</span></span></span><span class="line"><span class="cl"><span class="gi">+       Logger.Printf(sb.String())
</span></span></span><span class="line"><span class="cl"><span class="gi">+   }()
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>    var leastLoadedBroker *Broker
</span></span><span class="line"><span class="cl">    pendingRequests := math.MaxInt
</span></span><span class="line"><span class="cl">    for _, broker := range client.brokers {
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过上面的内核模块确认：</p>
<ol>
<li>seed broker tcp 连接已变成 <strong>TCP_CLOSE</strong> 状态了，但用户态没关掉。</li>
<li>registered broker tcp 连接存在同样问题。</li>
</ol>
<p>同时观察到有以下日志：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">client/metadata got error from broker 1193 while fetching metadata: write tcp 10.x.x.x:24180-&gt;10.y.y.y.y:9093: write: broken pipe
</span></span></code></pre></td></tr></table>
</div>
</div><p>这条日志便能解释上面 dmesg 日志减少、甚至消失的原因了：sarama 里随机抽取 broker 来发送请求，而这些 broker 的 tcp 连接已经不可用了，导致写数据时内核返回 <code>-EPIPE</code> 错误，sarama 便会关闭该 broker 的 tcp 连接。</p>
<p>但是，为什么 Kafka 服务端会主动关闭 tcp 连接呢？<del>有待进一步研究。</del></p>
<h3 id="32-修复-sarama">3.2. 修复 sarama</h3>
<p>在合适的地方，检查 tcp 连接对应的 socket 是否有 <code>sk-&gt;err</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">Broker</span><span class="p">)</span> <span class="nf">getSockOpt</span><span class="p">(</span><span class="nx">conn</span> <span class="o">*</span><span class="nx">net</span><span class="p">.</span><span class="nx">TCPConn</span><span class="p">,</span> <span class="nx">opt</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">file</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nf">File</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get file from connection: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">file</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span> <span class="c1">// Close the duplicated file descriptor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">sockErr</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">GetsockoptInt</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nf">Fd</span><span class="p">()),</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SOL_SOCKET</span><span class="p">,</span> <span class="nx">opt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get sockopt %d: %w&#34;</span><span class="p">,</span> <span class="nx">opt</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">sockErr</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">Broker</span><span class="p">)</span> <span class="nf">getSockError</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">b</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">connTCP</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">sockErr</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">getSockOpt</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">connTCP</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SO_ERROR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get socket error: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">sockErr</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">Errno</span><span class="p">(</span><span class="nx">sockErr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">client</span> <span class="o">*</span><span class="nx">client</span><span class="p">)</span> <span class="nf">checkSeedBrokersHealth</span><span class="p">(</span><span class="nx">brokers</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Broker</span><span class="p">)</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Broker</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">brokers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">healthyBrokers</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">Broker</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">brokers</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">broker</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">brokers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">broker</span><span class="p">.</span><span class="nf">getSockError</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Logger</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;client/seedbrokers close seed broker #%d at %s due to socket error: %v&#34;</span><span class="p">,</span> <span class="nx">broker</span><span class="p">.</span><span class="nf">ID</span><span class="p">(),</span> <span class="nx">broker</span><span class="p">.</span><span class="nf">Addr</span><span class="p">(),</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">safeAsyncClose</span><span class="p">(</span><span class="nx">broker</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">healthyBrokers</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">healthyBrokers</span><span class="p">,</span> <span class="nx">broker</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">healthyBrokers</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">client</span> <span class="o">*</span><span class="nx">client</span><span class="p">)</span> <span class="nf">checkBrokersHealth</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">broker</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">client</span><span class="p">.</span><span class="nx">brokers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">broker</span><span class="p">.</span><span class="nf">getSockError</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Logger</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;client/brokers close broker #%d at %s due to socket error: %v&#34;</span><span class="p">,</span> <span class="nx">broker</span><span class="p">.</span><span class="nf">ID</span><span class="p">(),</span> <span class="nx">broker</span><span class="p">.</span><span class="nf">Addr</span><span class="p">(),</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">safeAsyncClose</span><span class="p">(</span><span class="nx">broker</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">delete</span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">brokers</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">client</span><span class="p">.</span><span class="nx">seedBrokers</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">checkSeedBrokersHealth</span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">seedBrokers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">client</span><span class="p">.</span><span class="nx">deadSeeds</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">checkSeedBrokersHealth</span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">deadSeeds</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">client</span> <span class="o">*</span><span class="nx">client</span><span class="p">)</span> <span class="nf">updateMetadata</span><span class="p">(</span><span class="nx">data</span> <span class="o">*</span><span class="nx">MetadataResponse</span><span class="p">,</span> <span class="nx">allKnownMetaData</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">(</span><span class="nx">retry</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Closed</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">client</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Check health of existing brokers, including seed brokers, dead
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// seed brokers, and registered brokers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - if error occurred on broker&#39;s tcp socket, close the tcp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//   connection.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - if it&#39;s seed broker or dead seed broker, remove it from
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//   the list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">client</span><span class="p">.</span><span class="nf">checkBrokersHealth</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <code>updateMetadata()</code> 加了 <code>checkBrokersHealth()</code> 后，sarama 每 10 分钟就会关闭已经处于 <code>TCP_CLOSE</code> 状态的 tcp 连接。</p>
<p>通过上面的内核模块确认，只有少量的 tcp socket 处于 <code>TCP_CLOSE</code>，而且会在 10 分钟内被关闭掉。</p>
<p>更多修复细节，请查看 sarama PR:</p>
<ul>
<li><a href="https://github.com/IBM/sarama/pull/3384">fix: close broken tcp connections</a></li>
</ul>
<h2 id="4-改进内核协议栈">4. 改进内核协议栈</h2>
<ol>
<li>如果无法控制用户态行为，是否可以修改内核让系统管理员有办法处理这样的问题呢？</li>
<li>是否可以减少 dmesg 的日志？甚至完全消除掉？</li>
</ol>
<h3 id="41-计划新增-netipv4tcp_purge_receive_queue-sysctl">4.1. 计划新增 <code>net.ipv4.tcp_purge_receive_queue</code> sysctl</h3>
<p>核心改动如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gh">diff --git a/net/ipv4/tcp_input.c b/net/ipv4/tcp_input.c
</span></span></span><span class="line"><span class="cl"><span class="gh">index 198f8a0d37be0..a01d39c37be2f 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/net/ipv4/tcp_input.c
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/net/ipv4/tcp_input.c
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -4648,6 +4648,7 @@ EXPORT_IPV6_MOD(tcp_done_with_error);
</span></span></span><span class="line"><span class="cl"><span class="gu"></span> /* When we get a reset we do this. */
</span></span><span class="line"><span class="cl"> void tcp_reset(struct sock *sk, struct sk_buff *skb)
</span></span><span class="line"><span class="cl"> {
</span></span><span class="line"><span class="cl"><span class="gi">+   const struct net *net = sock_net(sk);
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>     int err;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     trace_tcp_receive_reset(sk);
</span></span><span class="line"><span class="cl"><span class="gu">@@ -4664,6 +4665,21 @@ void tcp_reset(struct sock *sk, struct sk_buff *skb)
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>         err = ECONNREFUSED;
</span></span><span class="line"><span class="cl">         break;
</span></span><span class="line"><span class="cl">     case TCP_CLOSE_WAIT:
</span></span><span class="line"><span class="cl"><span class="gi">+       /* RFC9293 3.10.7.4. Other States
</span></span></span><span class="line"><span class="cl"><span class="gi">+        *   Second, check the RST bit:
</span></span></span><span class="line"><span class="cl"><span class="gi">+        *     CLOSE-WAIT STATE
</span></span></span><span class="line"><span class="cl"><span class="gi">+        *
</span></span></span><span class="line"><span class="cl"><span class="gi">+        * If the RST bit is set, then any outstanding RECEIVEs and
</span></span></span><span class="line"><span class="cl"><span class="gi">+        * SEND should receive &#34;reset&#34; responses.  All segment queues
</span></span></span><span class="line"><span class="cl"><span class="gi">+        * should be flushed.  Users should also receive an unsolicited
</span></span></span><span class="line"><span class="cl"><span class="gi">+        * general &#34;connection reset&#34; signal.  Enter the CLOSED state,
</span></span></span><span class="line"><span class="cl"><span class="gi">+        * delete the TCB, and return.
</span></span></span><span class="line"><span class="cl"><span class="gi">+        *
</span></span></span><span class="line"><span class="cl"><span class="gi">+        * If net.ipv4.tcp_purge_receive_queue is enabled,
</span></span></span><span class="line"><span class="cl"><span class="gi">+        * sk_receive_queue will be flushed too.
</span></span></span><span class="line"><span class="cl"><span class="gi">+        */
</span></span></span><span class="line"><span class="cl"><span class="gi">+       if (unlikely(net-&gt;ipv4.sysctl_tcp_purge_receive_queue))
</span></span></span><span class="line"><span class="cl"><span class="gi">+           skb_queue_purge(&amp;sk-&gt;sk_receive_queue);
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>         err = EPIPE;
</span></span><span class="line"><span class="cl">         break;
</span></span><span class="line"><span class="cl">     case TCP_CLOSE:
</span></span></code></pre></td></tr></table>
</div>
</div><p>没错，如此改动的参考依据是 RFC9293 的 <code>3.10.7.4.</code> 小节。</p>
<h3 id="42-计划新增-page_pool_release_stalled-tracepoint">4.2. 计划新增 <code>page_pool_release_stalled</code> tracepoint</h3>
<p>核心改动如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gh">diff --git a/net/core/page_pool.c b/net/core/page_pool.c
</span></span></span><span class="line"><span class="cl"><span class="gh">index 1a5edec485f1..59a85887921c 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/net/core/page_pool.c
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/net/core/page_pool.c
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -1218,8 +1218,11 @@ static void page_pool_release_retry(struct work_struct *wq)
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>            (!netdev || netdev == NET_PTR_POISON)) {
</span></span><span class="line"><span class="cl">                int sec = (s32)((u32)jiffies - (u32)pool-&gt;defer_start) / HZ;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gd">-               pr_warn(&#34;%s() stalled pool shutdown: id %u, %d inflight %d sec\n&#34;,
</span></span></span><span class="line"><span class="cl"><span class="gd">-                       __func__, pool-&gt;user.id, inflight, sec);
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+               if (sec &gt;= DEFER_WARN_INTERVAL / HZ &amp;&amp; sec &lt; DEFER_WARN_INTERVAL * 2 / HZ)
</span></span></span><span class="line"><span class="cl"><span class="gi">+                       pr_warn(&#34;%s() stalled pool shutdown: id %u, %d inflight %d sec\n&#34;,
</span></span></span><span class="line"><span class="cl"><span class="gi">+                               __func__, pool-&gt;user.id, inflight, sec);
</span></span></span><span class="line"><span class="cl"><span class="gi">+               else
</span></span></span><span class="line"><span class="cl"><span class="gi">+                       trace_page_pool_release_stalled(pool, inflight, sec);
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>                pool-&gt;defer_warn = jiffies + DEFER_WARN_INTERVAL;
</span></span><span class="line"><span class="cl">        }
</span></span></code></pre></td></tr></table>
</div>
</div><p>如此改动的出发点是：</p>
<ol>
<li>至少有一次 <code>pr_warn()</code>。</li>
<li>后续通过 <code>page_pool_release_stalled</code> tracepoint 确认是否还有 inflight page。</li>
</ol>
<p>或许有更好的改进办法，有待进一步研究。</p>
<h2 id="5-小结">5. 小结</h2>
<p>首先，感谢以下大佬在我排查问题的过程中热情地参与讨论：</p>
<ul>
<li>Jason Xing</li>
<li>Lance Yang</li>
<li>Jiayuan Chen</li>
<li>Gray Liang</li>
</ul>
<p>接着，<a href="https://github.com/bpfsnoop/bpfsnoop">bpfsnoop</a> 在排查问题时发挥了关键作用，不用写比较复杂的 bpftrace 脚本。</p>
<p>在确认协议栈的行为后，用 AI 快速编写了 Python 脚本，用来快速复现协议栈的行为。</p>
<p>最后，等 sarama PR 合并之后，请更新 sarama 到最新的 commit，避免 tcp 连接泄漏问题。</p>

  </div>

  <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    
    <span class="item-content"> Leon Hwang </span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2025-11-23
        
    </span>
  </p>
  
  
</div>
<div class="post-reward">
    <img align="center" src="/profile.png" alt="profile.png" style="height: 120px;">
</div><footer class="post-footer">
    <div class="post-tags">
      <a href="/%20tags/linux/">Linux</a>
      <a href="/%20tags/page_pool/">page_pool</a>
      <a href="/%20tags/bpfsnoop/">bpfsnoop</a>
      <a href="/%20tags/tcp/">tcp</a>
      </div>
    <nav class="post-nav">
      
      <a class="next" href="/post/ebpf-talk-155-bpfsnoop-python-repl/">
        <span class="next-text nav-default">eBPF Talk: 使用 bpfsnoop 协助排查 Python REPL 异常</span>
        <span class="next-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav>
  </footer>
</article>
        </div>
        




<script src="https://giscus.app/client.js" data-repo="Asphaltt/asphaltt.github.io"
  data-repo-id="R_kgDOGUj7jQ" data-category="Announcements"
  data-category-id="DIC_kwDOGUj7jc4CSSYW" data-mapping="pathname" data-strict="0"
  data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="dark_dimmed" data-lang="zh-CN"
  data-loading="lazy" crossorigin="anonymous" async>
  </script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/giscus/giscus">comments powered by
    giscus.</a></noscript>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:le0nhwan9@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/LeonHuayra" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://github.com/Asphaltt" class="iconfont icon-github" title="github"></a>
  <a href="https://blog.leonhw.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 -
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy;
    2021 -
    2025<span class="heart"><i class="iconfont icon-heart"></i></span>
    
    <span> Leon Hwang </span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script><script id="baidu_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?ce3c909090b0d435716d2679ef1989cf";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>






</body>
</html>
